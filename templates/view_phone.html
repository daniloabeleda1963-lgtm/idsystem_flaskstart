<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Card Generator (User Friendly)</title>
    
    <!-- PDF GENERATION LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* === USER FRIENDLY STYLES === */
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* === BIG BUTTONS FOR CELPON === */
        .action-container {
            background: white;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
        }
        
        .big-btn {
            width: 100%;
            padding: 18px 20px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .big-btn:active { transform: scale(0.98); }
        
        .btn-print { background: #2563eb; color: white; }
        .btn-print:hover { background: #1d4ed8; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        
        .btn-save { background: #10b981; color: white; }
        .btn-save:hover { background: #059669; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        
        .btn-img { background: #f59e0b; color: white; }
        .btn-img:hover { background: #d97706; box-shadow: 0 4px 12px rgba(245,158,11,0.3); }

        .btn-merge { background: #8b5cf6; color: white; }
        .btn-merge:hover { background: #7c3aed; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }

        /* === WORKSPACE === */
        .workspace {
            flex-grow: 1;
            background: #e5e7eb;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 10px;
            gap: 20px;
        }

        /* === UPDATED: SIMPLE IMAGE CONTAINER === */
        .image-container {
            position: relative;
            background-color: #fff;
            width: 100%;
            max-width: 400px; /* Standard ID width */
            /* Height is automatic based on image aspect ratio */
            background-repeat: no-repeat;
            background-size: contain;
            background-position: top center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            user-select: none;
            margin: 0 auto;
            display: none; /* Hidden by default until loaded */
        }

        /* === SIMPLIFIED DROPDOWN === */
        .member-select {
            width: 100%;
            max-width: 600px;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background: white;
            margin-bottom: 10px;
        }

        /* === LOADING OVERLAY === */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* === FOOTER INFO === */
        .footer-info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }

    </style>
</head>
<body>

    <!-- === LOADING OVERLAY === -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Searching... Please wait.</div>
    </div>

    <!-- === MAIN CONTENT === -->
    <div class="workspace">
        
        <!-- SELECT MEMBER DROPDOWN (SIMPLIFIED) -->
        <!-- Note: ONCHANGE Logic will trigger search -->
        <select id="memberSelect" class="member-select" onchange="searchMember()">
            <option value="" disabled selected>-- Select Member ID (Start Typing) --</option>
            <!-- Options will be populated by JS -->
        </select>

        <!-- === UPDATED: IMAGE DISPLAY AREA === -->
        <!-- This div will ONLY contain an <img> tag. No complex rendering. -->
        <div id="idImageContainer" class="image-container">
            <img id="idCardImg" src="" style="width:100%; height:auto; display:block;" alt="ID Card">
        </div>

        <!-- === USER FRIENDLY ACTION BUTTONS === -->
        <div class="action-container">
            
            <!-- 1. REFRESH / LOAD DATA -->
            <button class="big-btn btn-save" onclick="loadSavedData()">
                üîÑ REFRESH / RELOAD DATA
            </button>

            <!-- 2. SCREENSHOT / SAVE IMAGE -->
            <!-- Since we are displaying a static image, we can just link to it -->
            <button class="big-btn btn-img" onclick="openImageLink()">
                üì∏ OPEN / SAVE IMAGE
            </button>

            <!-- ========================================== -->
            <!-- NEW BUTTON: DOWNLOAD PDF (ADDED HERE) -->
            <!-- ========================================== -->
            <button class="big-btn btn-print" onclick="downloadPDFImage()">
                ‚¨áÔ∏è DOWNLOAD PDF
            </button>

            <!-- 3. BACK TO HOME -->
            <button class="big-btn btn-merge" onclick="goHome()">
                üè† BACK TO HOME
            </button>

            <div class="footer-info">
                Status: <span id="statusText" style="color: green;">Ready</span>
            </div>
        </div>
    </div>

    <script>
        const API_URL = ''; 
        const memberSelect = document.getElementById('memberSelect');
        const idImageContainer = document.getElementById('idImageContainer');
        const idCardImg = document.getElementById('idCardImg');
        const statusText = document.getElementById('statusText');
        const loadingOverlay = document.getElementById('loading-overlay');

        // State
        let allMembers = [];
        let currentImageUrl = "";

        // ==========================================
        // 1. INITIALIZATION (LOAD MEMBERS LIST)
        // ==========================================
        window.addEventListener('DOMContentLoaded', async () => {
            statusText.textContent = "Loading System...";
            showLoading(true);

            try {
                await fetchMembers();
                statusText.textContent = "Ready. Select a member.";
            } catch (error) {
                console.error("Init Error:", error);
                statusText.textContent = "Error loading data.";
            } finally {
                showLoading(false);
            }
        });

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // ==========================================
        // 2. FETCH MEMBERS
        // ==========================================
        async function fetchMembers() {
            try {
                // Fetch first 50 members only for speed
                const response = await fetch(`${API_URL}/api/members/json?limit=50`);
                if (response.ok) {
                    const data = await response.json();
                    allMembers = Array.isArray(data) ? data : [];
                    populateDropdown();
                }
            } catch (e) {
                console.error("Member fetch failed", e);
                alert("Error fetching members.");
            }
        }

        function populateDropdown() {
            memberSelect.innerHTML = '<option value="" disabled selected>-- Select Member ID (Start Typing) --</option>';
            allMembers.forEach((member, index) => {
                const option = document.createElement('option');
                option.value = index; 
                // Display Name and ID Number for easier search
                option.textContent = `${member.name} (${member.idnumb || member.id})`;
                memberSelect.appendChild(option);
            });
        }

        function loadSavedData() {
            showLoading(true);
            setTimeout(() => {
                fetchMembers().then(() => {
                    statusText.textContent = "Data Refreshed.";
                    showLoading(false);
                });
            }, 500);
        }

        function goHome() {
            window.location.href = '/';
        }

        // ==========================================
        // 3. SEARCH MEMBER LOGIC (NEW APPROACH)
        // ==========================================
        async function searchMember() {
            const index = memberSelect.value;
            
            // Clear previous image if no selection
            if (index === "" || index === null) {
                idImageContainer.style.display = 'none';
                idCardImg.src = "";
                statusText.textContent = "Select a member.";
                return;
            }

            const member = allMembers[index];
            if (!member) return;

            showLoading(true);
            statusText.textContent = `Searching for ${member.name}...`;

            try {
                // === THE KEY LOGIC: CHECK IF GENERATED CARD EXISTS ===
                // We check the 'generated_card_image' field from our database
                if (member.generated_card_image) {
                    // CASE A: Card already generated. Show it immediately!
                    idCardImg.src = member.generated_card_image;
                    idImageContainer.style.display = 'block';
                    statusText.textContent = `Found ID for ${member.name}. Ready to print.`;
                    currentImageUrl = member.generated_card_image;
                } else {
                    // CASE B: No card generated yet.
                    idImageContainer.style.display = 'none';
                    statusText.textContent = `No ID generated yet for ${member.name}. Please ask Admin to generate.`;
                    alert(`Member found: ${member.name}\n\nBut ID card image has NOT been generated yet.\n\nPlease contact to Admin (Laptop) to click "SAVE CARD" first.`);
                    currentImageUrl = "";
                }

            } catch (error) {
                console.error(error);
                statusText.textContent = "Error searching.";
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // 4. HELPER: OPEN IMAGE LINK
        // ==========================================
        function openImageLink() {
            if (currentImageUrl) {
                // Opens the image in a new tab (or downloads depending on browser)
                window.open(currentImageUrl, '_blank');
            } else {
                alert("No image to save.");
            }
        }

        // ==========================================
        // 5. NEW: DOWNLOAD PDF FUNCTION
        // ==========================================
        async function downloadPDFImage() {
            // Check if image is loaded
            if (!currentImageUrl) {
                alert("No ID card image loaded yet. Please select a member first.");
                return;
            }

            showLoading(true);
            statusText.textContent = "Generating PDF...";

            try {
                // 1. Create a temporary image element to capture the dimensions
                // We need to make sure the image is loaded before capturing
                const imgElem = idCardImg;
                
                // Wait for image to ensure it's fully rendered
                if (!imgElem.complete) {
                    await new Promise(resolve => imgElem.onload = resolve);
                }

                // 2. Use html2canvas on the CONTAINER div
                // We target the container so we capture the white background and shadow
                const canvas = await html2canvas(idImageContainer, {
                    scale: 2, // High Quality
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });

                // 3. Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Calculate dimensions to fit A4
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 10;

                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;

                // Set a target height (e.g., 80mm or full width)
                const targetHeight_mm = 80; 
                const targetWidth_mm = targetHeight_mm * ratio;

                // Center image on page
                const x = (pageWidth - targetWidth_mm) / 2;
                const y = (pageHeight - targetHeight_mm) / 2;

                doc.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', x, y, targetWidth_mm, targetHeight_mm);
                
                doc.save(`ID_Card_${new Date().toISOString().slice(0,10)}.pdf`);
                statusText.textContent = "PDF Downloaded!";

            } catch (error) {
                console.error(error);
                alert("Error generating PDF: " + error.message);
            } finally {
                showLoading(false);
            }
        }

    </script>
</body>
</html>
