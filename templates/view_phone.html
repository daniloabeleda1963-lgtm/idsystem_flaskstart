<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Card Generator (User Friendly)</title>
    
    <!-- PDF GENERATION LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* === USER FRIENDLY STYLES === */
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* === BIG BUTTONS FOR CELPON === */
        .action-container {
            background: white;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; /* Default Visible */
            flex-direction: column;
            gap: 15px;
            z-index: 100;
            transition: opacity 0.3s;
        }
        
        .big-btn {
            width: 100%;
            padding: 18px 20px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .big-btn:active { transform: scale(0.98); }
        
        .btn-print { background: #2563eb; color: white; }
        .btn-print:hover { background: #1d4ed8; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        
        .btn-save { background: #10b981; color: white; }
        .btn-save:hover { background: #059669; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        
        .btn-img { background: #f59e0b; color: white; }
        .btn-img:hover { background: #d97706; box-shadow: 0 4px 12px rgba(245,158,11,0.3); }

        .btn-merge { background: #8b5cf6; color: white; }
        .btn-merge:hover { background: #7c3aed; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }

        /* === WORKSPACE === */
        .workspace {
            flex-grow: 1;
            background: #e5e7eb;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 10px;
            gap: 20px;
        }

        /* === UPDATED: SIMPLE IMAGE CONTAINER === */
        .image-container {
            position: relative;
            background-color: #fff;
            width: 100%;
            max-width: 400px; /* Default limit */
            height: auto;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: top center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            user-select: none;
            margin: 0 auto;
            display: none; /* Hidden by default until loaded */
        }

        /* === SIMPLIFIED DROPDOWN === */
        .member-select {
            width: 100%;
            max-width: 600px;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background: white;
            margin-bottom: 10px;
        }

        /* === BACK BUTTON (FIXED: Clean Arrow) === */
        #backButton {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 200;
            width: 50px;
            height: 50px;
            border-radius: 50%; /* Circle */
            background: #ef4444;
            color: white;
            border: none;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: none; /* Hidden initially */
            align-items: center;
            justify-content: center;
            /* Animation */
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* === LOADING OVERLAY === */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* === FOOTER INFO === */
        .footer-info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }

    </style>
</head>
<body>

    <!-- === FLOATING BACK BUTTON (Visible only in Clean Mode) === -->
    <button id="backButton" onclick="backToSearch()">üîô</button>

    <!-- === LOADING OVERLAY === -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Searching... Please wait.</div>
    </div>

    <!-- === MAIN CONTENT === -->
    <div class="workspace">
        
        <!-- SELECT MEMBER DROPDOWN -->
        <select id="memberSelect" class="member-select" onchange="searchMember()" oninput="smartFilter()">
            <option value="" disabled selected>-- Start Typing Name or ID --</option>
            <!-- Options will be populated by JS -->
        </select>

        <!-- === IMAGE DISPLAY AREA === -->
        <div id="idImageContainer" class="image-container">
            <img id="idCardImg" src="" style="width:100%; height:auto; display:block;" alt="ID Card">
        </div>

        <!-- === USER FRIENDLY ACTION BUTTONS === -->
        <div class="action-container" id="actionContainer">
            
            <!-- 1. REFRESH / LOAD DATA -->
            <button class="big-btn btn-save" onclick="loadSavedData()">
                üîÑ REFRESH / RELOAD DATA
            </button>

            <!-- 2. DOWNLOAD IMAGE (FIXED: Direct Download, not Open) -->
            <button class="big-btn btn-img" onclick="downloadImageFile()">
                üì∏ SAVE IMAGE
            </button>

            <!-- 3. DOWNLOAD PDF (FIXED: Full Size Capture) -->
            <button class="big-btn btn-print" onclick="downloadPDFImage()">
                ‚¨áÔ∏è DOWNLOAD PDF
            </button>

            <!-- 4. BACK TO HOME -->
            <button class="big-btn btn-merge" onclick="goHome()">
                üè† BACK TO HOME
            </button>

            <div class="footer-info">
                Status: <span id="statusText" style="color: green;">Ready</span>
            </div>
        </div>
    </div>

    <script>
        const API_URL = ''; 
        const memberSelect = document.getElementById('memberSelect');
        const idImageContainer = document.getElementById('idImageContainer');
        const idCardImg = document.getElementById('idCardImg');
        const statusText = document.getElementById('statusText');
        const loadingOverlay = document.getElementById('loading-overlay');
        const actionContainer = document.getElementById('actionContainer');
        const backButton = document.getElementById('backButton');

        // State
        let allMembers = [];
        let currentImageUrl = "";

        // ==========================================
        // 1. INITIALIZATION (LOAD MEMBERS LIST)
        // ==========================================
        window.addEventListener('DOMContentLoaded', async () => {
            statusText.textContent = "Loading System...";
            showLoading(true);

            try {
                await fetchMembers();
                statusText.textContent = "Ready. Start typing name.";
            } catch (error) {
                console.error("Init Error:", error);
                statusText.textContent = "Error loading data.";
            } finally {
                showLoading(false);
            }
        });

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // ==========================================
        // 2. FETCH MEMBERS
        // ==========================================
        async function fetchMembers() {
            try {
                // Fetch first 50 members only for speed
                const response = await fetch(`${API_URL}/api/members/json?limit=50`);
                if (response.ok) {
                    const data = await response.json();
                    allMembers = Array.isArray(data) ? data : [];
                    populateDropdown();
                }
            } catch (e) {
                console.error("Member fetch failed", e);
                alert("Error fetching members.");
            }
        }

        function populateDropdown() {
            memberSelect.innerHTML = '<option value="" disabled selected>-- Start Typing Name or ID --</option>';
            allMembers.forEach((member, index) => {
                const option = document.createElement('option');
                option.value = index; 
                // Display Name and ID Number for easier search
                option.textContent = `${member.name} (${member.idnumb || member.id})`;
                memberSelect.appendChild(option);
            });
        }

        function loadSavedData() {
            showLoading(true);
            setTimeout(() => {
                fetchMembers().then(() => {
                    statusText.textContent = "Data Refreshed.";
                    showLoading(false);
                });
            }, 500);
        }

        function goHome() {
            window.location.href = '/';
        }

        // ==========================================
        // 3. SMART FILTER LOGIC
        // ==========================================
        function smartFilter() {
            const query = memberSelect.value.toLowerCase();
            const options = memberSelect.options;

            // Loop through all options (skip first disabled placeholder)
            for (let i = 1; i < options.length; i++) {
                const text = options[i].text.toLowerCase();
                
                // If query matches part of name, SHOW IT.
                // Else, HIDE IT.
                if (text.includes(query)) {
                    options[i].style.display = "";
                } else {
                    options[i].style.display = "none";
                }
            }
        }

        // ==========================================
        // 4. SEARCH / SHOW CARD LOGIC (Clean Mode)
        // ==========================================
        async function searchMember() {
            const index = memberSelect.value;
            
            // Clear previous image if no selection
            if (index === "" || index === null) {
                idImageContainer.style.display = 'none';
                idCardImg.src = "";
                statusText.textContent = "Select a member.";
                return;
            }

            const member = allMembers[index];
            if (!member) return;

            showLoading(true);
            statusText.textContent = `Searching for ${member.name}...`;

            try {
                // === CHECK IF GENERATED CARD EXISTS ===
                if (member.generated_card_image) {
                    // SUCCESS: Show Image + CLEAN MODE
                    idCardImg.src = member.generated_card_image;
                    idImageContainer.style.display = 'block';
                    statusText.textContent = `Found ID for ${member.name}.`;
                    currentImageUrl = member.generated_card_image;

                    // === CLEAN MODE: HIDE BUTTONS, SHOW ARROW ===
                    actionContainer.style.display = 'none';
                    memberSelect.style.display = 'none';
                    backButton.style.display = 'flex'; // Show Arrow
                } else {
                    // FAIL: No card generated.
                    idImageContainer.style.display = 'none';
                    statusText.textContent = `No ID generated yet.`;
                    alert(`Member found: ${member.name}\n\nBut ID card image has NOT been generated yet.\n\nPlease contact Admin to click "SAVE CARD".`);
                    currentImageUrl = "";
                }

            } catch (error) {
                console.error(error);
                statusText.textContent = "Error searching.";
            } finally {
                showLoading(false);
            }
        }

        function backToSearch() {
            // Show controls again
            actionContainer.style.display = 'flex';
            memberSelect.style.display = 'block';
            backButton.style.display = 'none'; // Hide Arrow
            
            // Clear Image
            idImageContainer.style.display = 'none';
            idCardImg.src = "";
            statusText.textContent = "Ready. Select a member.";
        }

        // ==========================================
        // 5. DOWNLOAD IMAGE FUNCTION (FIXED: Direct Download)
        // ==========================================
        async function downloadImageFile() {
            if (!currentImageUrl) {
                alert("No ID card image loaded yet.");
                return;
            }

            showLoading(true);
            statusText.textContent = "Downloading...";

            try {
                // 1. Fetch the image as Blob
                const response = await fetch(currentImageUrl);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const blob = await response.blob();
                
                // 2. Create a temporary link to trigger download
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // 3. Set filename
                const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g,"");
                link.download = `ID_Card_${timestamp}.png`;
                
                // 4. Trigger click
                document.body.appendChild(link);
                link.click();
                
                // 5. Cleanup
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                statusText.textContent = "Image Saved! (Check Gallery)";

            } catch (error) {
                console.error("Download Error:", error);
                alert("Error downloading image: " + error.message);
                statusText.textContent = "Error.";
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // 6. DOWNLOAD PDF FUNCTION (FIXED: Full Size Capture)
        // ==========================================
        async function downloadPDFImage() {
            if (!currentImageUrl) {
                alert("No ID card image loaded yet.");
                return;
            }

            showLoading(true);
            statusText.textContent = "Generating PDF...";

            try {
                // === FIX 1: REMOVE WIDTH CONSTRAINTS ===
                // Before capturing, we remove max-width so we capture the FULL image size
                // This fixes the "maliit sa canvas" issue
                const originalMaxWidth = idImageContainer.style.maxWidth;
                const originalWidth = idImageContainer.style.width;
                
                idImageContainer.style.maxWidth = 'none'; // Remove 400px limit
                idImageContainer.style.width = 'auto'; // Let it grow to natural size

                // === FIX 2: WAIT FOR IMAGE TO RENDER ===
                const imgElem = idCardImg;
                if (!imgElem.complete) {
                    await new Promise(resolve => imgElem.onload = resolve);
                }

                // 3. Capture with HIGH QUALITY
                // Since we removed the width limit, this will capture the full res image
                const canvas = await html2canvas(idImageContainer, {
                    scale: 2, // Keep scale 2 for quality
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });

                // 4. Restore styles
                idImageContainer.style.maxWidth = originalMaxWidth;
                idImageContainer.style.width = originalWidth;

                // 5. Setup PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210; // A4
                const pageHeight = 297;
                const margin = 10;

                // 6. Calculate Fit
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;

                const availableWidth = pageWidth - (margin * 2);
                const availableHeight = pageHeight - (margin * 2);

                let targetWidth_mm = availableWidth;
                let targetHeight_mm = targetWidth_mm / ratio;

                // If height is too big, base on height
                if (targetHeight_mm > availableHeight) {
                    targetHeight_mm = availableHeight;
                    targetWidth_mm = targetHeight_mm * ratio;
                }

                // Center
                const x = (pageWidth - targetWidth_mm) / 2;
                const y = (pageHeight - targetHeight_mm) / 2;

                doc.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', x, y, targetWidth_mm, targetHeight_mm);
                doc.save(`ID_Card_FullSize.pdf`);
                statusText.textContent = "PDF Downloaded!";

            } catch (error) {
                console.error(error);
                alert("Error generating PDF: " + error.message);
            } finally {
                showLoading(false);
            }
        }

    </script>
</body>
</html>
