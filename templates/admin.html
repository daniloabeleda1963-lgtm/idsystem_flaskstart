<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Layout Editor - Final w/ Chapter</title>
    
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            border-right:1px solid #334155;
            flex-shrink: 0;
            z-index: 200;
        }
        .sidebar-header {
            padding: 15px;
            background: #0f172a;
            font-weight: bold;
            border-bottom:1px solid #334155;
        }
        .sidebar-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .sidebar-group { margin-bottom: 15px; }
        .sidebar-group-title {
            font-size: 11px;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .draggable-item {
            background: #334155;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: grab;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #475569;
        }
        .draggable-item:hover { background: #475569; border-color: var(--primary-color); }
        .draggable-item:active { cursor: grabbing; }

        /* --- Admin Forms Styles --- */
        .admin-forms-panel {
            background: #0f172a;
            padding: 10px;
            border-bottom: 1px solid #334155;
        }
        .admin-input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }
        .admin-input {
            flex: 1;
            padding: 4px;
            border: none;
            border-radius: 3px;
            background: #334155;
            color: white;
            font-size: 12px;
            box-sizing: border-box;
        }
        .admin-select {
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 4px;
            background: #334155;
            color: white;
            font-size: 12px;
            margin-bottom: 5px;
            cursor: pointer;
            box-sizing: border-box;
        }
        .admin-btn-group {
            display: flex;
            gap: 5px;
        }
        .admin-btn {
            flex: 1;
            padding: 4px;
            font-size: 11px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            color: white;
            background: #2563eb;
            box-sizing: border-box;
        }
        .admin-btn:hover { background: #1d4ed8; }
        .btn-add { background: var(--primary-color); }
        .btn-del { background: var(--danger-color, #ef4444); }
        .btn-save { background: var(--success-color, #10b981); }

        /* --- Transfer List Styles --- */
        .transfer-box {
            display: flex;
            gap: 4px;
            height: 180px; 
            margin-bottom: 5px;
        }
        .list-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .list-col label {
            font-size: 10px;
            color: #94a3b8;
            text-align: center;
            margin-bottom: 2px;
        }
        .listbox-select {
            height: 100%;
            padding: 4px;
            background: #334155;
            border: 1px solid #475569;
            color: white;
            font-size: 11px;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .toolbar {
            background: white;
            padding: 8px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .toolbar-left { display: flex; gap: 10px; align-items: center; }
        .toolbar-right { display: flex; gap: 8px; align-items: center; }
        button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        button:hover { background: #f9fafb; }
        button.primary { background: var(--primary-color); color: white; border: none; }
        button.danger { background: #ef4444; color: white; border: none; }
        .zoom-display { font-size: 12px; color: #666; width: 40px; text-align: center; }
        input[type="range"] { width: 80px; cursor: pointer; }
        
        /* NEW: Rotation Textbox Style */
        input[type="number"].rotate-input {
            width: 50px;
            padding: 4px;
            font-size: 12px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .workspace {
            flex-grow: 1;
            background: #e5e7eb;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 50px;
        }
        .canvas-wrapper {
            position: relative;
            background-color: #fff;
            width: 800px;
            height: 400px;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: top left;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            user-select: none;
            transform-origin: top center; 
        }
        /* --- ELEMENTS --- */
        .canvas-element {
            position: absolute;
            cursor: move;
            background: rgba(37, 99, 235, 0.15);
            border: 1px dashed var(--primary-color);
            color: #1e3a8a;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-sizing: border-box;
            z-index: 100;
            overflow: hidden;
            transform: rotate(0deg);
            writing-mode: horizontal-tb; 
        }
        .canvas-element:hover {
            border: 1px solid var(--primary-color);
            background: rgba(37, 99, 235, 0.25);
        }
        .canvas-element.selected {
            border: 2px solid var(--primary-color);
            background: rgba(37, 99, 235, 0.3);
            z-index: 101;
        }
        .canvas-element.is-photo { background: rgba(239, 68, 68, 0.1); border-color: red; color: red; }
        .canvas-element.is-line {
            background: transparent; 
            border-bottom: 2px solid black; 
            height: 0px !important; 
            cursor: ns-resize; 
            border-top: none; border-left: none; border-right: none;
            min-height: 2px;
        }
        .canvas-element.is-box { background: transparent; border: 1px solid black; }
        .canvas-element.is-frosted {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .canvas-element.is-image {
            background: transparent;
            border: 1px dashed #10b981; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .canvas-element.is-image img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        /* --- MS WORD TEXTBOX STYLE --- */
        .custom-textbox {
            position: absolute;
            background: transparent;
            border: 1px dashed #94a3b8; 
            color: #000;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
            z-index: 200;
            min-width: 200px; 
            min-height: 20px;
            cursor: text; 
            padding: 4px;
            outline: none;
            white-space: pre-wrap;
            line-height: 1.4;
            text-align: left;
            transform: rotate(0deg);
            writing-mode: horizontal-tb;
        }
        .custom-textbox.selected {
            border: 2px solid var(--primary-color);
            cursor: move; 
        }
        .custom-textbox:hover {
            border: 1px solid var(--primary-color);
        }
        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border: 1px solid var(--primary-color);
            display: none;
            z-index: 300;
        }
        .canvas-element.selected .resize-handle, 
        .custom-textbox.selected .resize-handle { display: block; }
        .rh-se { bottom: -4px; right: -4px; cursor: nwse-resize; }
        .rh-sw { bottom: -4px; left: -4px; cursor: nesw-resize; }
        .rh-ne { top: -4px; right: -4px; cursor: nesw-resize; }
        .rh-nw { top: -4px; left: -4px; cursor: nwse-resize; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: white;
            width: 100%;
            max-width: 800px;
            height: 90%;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background-color: #2563eb;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .close-modal-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 10px;
            border-radius: 4px;
        }
        .close-modal-btn:hover { background: rgba(255, 255, 255, 0.4); }

        .modal-body {
            flex-grow: 1;
            border: none;
            width: 100%;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">üß© Toolbox</div>
        
        <!-- === MEMBERS DATA PANEL === -->
        <div class="admin-forms-panel">
            <div class="sidebar-group-title" style="color: #fff;">MEMBERS DATA (PRINT)</div>
            
            <input type="date" id="printDateInput" class="admin-input">
            <button class="admin-btn" onclick="loadPrintMembers()" style="margin-top:5px; margin-bottom:5px;">üë• Load List</button>
            
            <div style="margin-top: 10px; margin-bottom: 5px;">
                <label class="listbox-select">SELECT TO PRINT</label>
                <select id="printMembersList" class="listbox-select" multiple></select>
            </div>

            <button class="admin-btn btn-add" onclick="loadAndMergeLayout()" style="background: #8b5cf6; margin-bottom: 5px;">üìÇ LOAD & MERGE (PRINT)</button>
        </div>

        <!-- === OFFICERS PANEL === -->
        <div class="admin-forms-panel">
            <div class="sidebar-group-title" style="color: #fff;">OFFICERS LIST</div>
            
            <select id="officerSelect" class="admin-select" onchange="updateDraggableOfficer()">
                <option value="">-- Select Officer --</option>
            </select>

            <div id="officerDragItem" class="draggable-item" draggable="true" data-type="officer-group" style="opacity: 0.5; pointer-events: none; margin-top: 5px;">
                üë§ Drag Selected Officer
            </div>
        </div>

        <!-- === ADMIN FORMS PANEL === -->
        <div class="admin-forms-panel">
            <div class="sidebar-group-title" style="color: #fff;">Admin Forms (Table: admin_forms)</div>
            
            <!-- UPDATED FIX: Added onfocus AND onclick for instant reaction -->
            <select id="adminFormsSelect" class="admin-select" onchange="checkAdminFormSelection()" onclick="checkAdminFormSelection()" onfocus="if(this.value) checkAdminFormSelection()">
                <!-- Options loaded via JS -->
            </select>

            <div class="admin-input-group">
                <input type="text" id="newFormName" class="admin-input" placeholder="New Form Name...">
                <button class="admin-btn btn-add" onclick="addAdminForm()">Add</button>
            </div>

            <div class="admin-btn-group">
                <button class="admin-btn btn-del" onclick="deleteAdminForm()">Delete</button>
                <button class="admin-btn btn-save" onclick="saveAdminForms()">Save List</button>
            </div>
        </div>

        <div class="sidebar-list">
            <div class="sidebar-group-title">Front Side</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="FULL NAME">üìù FULL NAME</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="PSEUDO NAME">üìù PSEUDO NAME</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="BIRTHDATE">üìÖ BIRTHDATE</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="ID NUMBER">üÜî ID NUMBER</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="BLOOD TYPE">ü©∏ BLOOD TYPE</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="CONTACT NO">üìû CONTACT NO</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="ADDRESS">üè† ADDRESS</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="HEIGHT">üìè HEIGHT</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="WEIGHT">‚öñÔ∏è WEIGHT</div>
            
            <!-- ADDED: CHAPTER ITEM -->
            <div class="draggable-item" draggable="true" data-type="text" data-caption="CHAPTER">üè¢ CHAPTER</div>
            
            <div class="sidebar-group-title">Back Side / Emergency</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="OR CODES">üìÑ OR CODES</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="EMERGENCY PERSON NAME">üöë EMERGENCY NAME</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="EMERGENCY CONTACT NO">üìû EMERGENCY CONTACT</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="EMERGENCY ADDRESS">üè† EMERGENCY ADDR</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="DATE ISSUED">üìÖ DATE ISSUED</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="VALID UNTIL">‚è≥ VALID UNTIL</div>
            
            <div class="sidebar-group-title">Signature</div>
            <div class="draggable-item" draggable="true" data-type="sig-box" data-caption="SIGNATURE">‚úçÔ∏è SIGNATURE BOX</div>

            <div class="sidebar-group-title">Shapes & Effects</div>
            <div class="draggable-item" draggable="true" data-type="photo" data-caption="PHOTO">üñºÔ∏è PHOTO</div>
            <div class="draggable-item" draggable="true" data-type="line" data-caption="LINE">üìè LINE</div>
            <div class="draggable-item" draggable="true" data-type="box" data-caption="BOX">‚¨ú BOX</div>
            <div class="draggable-item" draggable="true" data-type="frosted-box" data-caption="FROSTED BOX">üßä FROSTED BOX</div>
        </div>
    </div>

    <!-- MAIN AREA -->
    <div class="main-content">
        
        <!-- TOP TOOLBAR -->
        <div class="toolbar">
            <div class="toolbar-left">
                <label class="primary" style="padding: 6px 12px; cursor:pointer; border-radius: 4px; background: #6366f1; color: white;">
                    üìÅ Upload Template
                    <input type="file" id="templateUpload" accept="image/*" style="display: none;">
                </label>
                <label class="primary" style="padding: 6px 12px; cursor:pointer; border-radius: 4px; background: #10b981; color: white;">
                    üñºÔ∏è Upload Logo
                    <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                </label>
                <button class="primary" style="background: #f59e0b; color: white; border: none;" onclick="addCustomTextbox()">
                    ‚ûï Add Text (MS Word)
                </button>
                <span id="filename" style="font-size: 12px; color: #666;">No template loaded</span>
            </div>

            <div class="toolbar-right">
                <span style="font-size: 12px;">Zoom:</span>
                <input type="range" id="zoomSlider" min="0.3" max="2.0" step="0.1" value="1.0">
                <span id="zoomValue" class="zoom-display">100%</span>
                
                <div style="border-left: 1px solid #ddd; padding-left: 10px; gap: 5px; align-items: center; display: flex;">
                    
                    <!-- FONT PROPERTIES -->
                    <select id="propFontFamily" title="Font Family">
                        <option value="'Segoe UI', sans-serif">Segoe UI</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="Impact, sans-serif">Impact</option>
                        <option value="Georgia, serif">Georgia</option>
                    </select>
                    <input type="color" id="propTextColor" value="#1e3a8a" title="Text Color">
                    <span style="font-size: 11px; font-weight: bold; color: #555;">SIZE:</span>
                    <input type="number" id="propSize" value="12" title="Font Size">
                    <select id="propFont" title="Font Style">
                        <option value="normal">Normal</option>
                        <option value="bold">Bold</option>
                    </select>

                    <!-- UPDATED: ROTATION WITH TEXTBOX -->
                    <span style="font-size: 11px; font-weight: bold; color: #555; margin-left: 5px;">üîÑ ROTATE:</span>
                    <input type="range" id="propRotate" min="0" max="360" value="0" style="width: 80px;" title="Rotate Text">
                    <input type="number" id="propRotateText" class="rotate-input" value="0" min="0" max="360" title="Exact Degrees">
                    <span style="font-size: 11px;">¬∞</span>
                    <button onclick="setRotate(180)" title="Quick Rotate 180¬∞" style="padding: 2px 6px; font-size: 11px;">180¬∞</button>
                    <button onclick="setRotate(0)" title="Reset Rotation" style="padding: 2px 6px; font-size: 11px;">Reset</button>

                </div>

                <div style="border-left: 1px solid #ddd; padding-left: 10px; gap: 5px; display:flex;">
                    <button class="danger" onclick="deleteSelected()">üóëÔ∏è Delete</button>
                    <button class="primary" onclick="saveLayout()">üíæ Save</button>
                    <button class="primary" style="background: #8b5cf6;" onclick="loadLayout()">üìÇ Load (Template)</button>
                </div>
            </div>
        </div>

        <!-- WORKSPACE -->
        <div class="workspace" id="workspace">
            <div class="canvas-wrapper" id="editorCanvas">
                <!-- Items appear here -->
            </div>
        </div>

    </div>

    <!-- NEW: SIGNATURE MODAL -->
    <div id="signatureModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Officer Signature</h3>
                <button class="close-modal-btn" onclick="closeModal('signatureModal')">‚úñ</button>
            </div>
            <iframe src="/signature.html" class="modal-body" frameborder="0"></iframe>
        </div>
    </div>

    <!-- NEW: MODE PAYMENT MODAL -->
    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Mode of Payment</h3>
                <button class="close-modal-btn" onclick="closeModal('paymentModal')">‚úñ</button>
            </div>
            <iframe src="/mode_payment.html" class="modal-body" frameborder="0"></iframe>
        </div>
    </div>

    <!-- NEW: CAPTION CHANGER MODAL -->
    <div id="captionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Caption Changer</h3>
                <button class="close-modal-btn" onclick="closeModal('captionModal')">‚úñ</button>
            </div>
            <iframe src="/caption_changer.html" class="modal-body" frameborder="0"></iframe>
        </div>
    </div>

    <script>
        // ==========================================
        // CONSTANTS & SETUP
        // ==========================================
        const API_URL = ''; 
        const canvas = document.getElementById('editorCanvas');
        const workspace = document.getElementById('workspace');
        const uploadInput = document.getElementById('templateUpload');
        const logoUploadInput = document.getElementById('logoUpload');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        const filenameSpan = document.getElementById('filename');
        const propSize = document.getElementById('propSize');
        const propFont = document.getElementById('propFont');
        const propFontFamily = document.getElementById('propFontFamily');
        const propTextColor = document.getElementById('propTextColor');
        
        // NEW: Rotation Elements (Slider & Textbox)
        const propRotate = document.getElementById('propRotate');
        const propRotateText = document.getElementById('propRotateText');

        let isDragging = false;
        let isResizing = false;
        let currentEl = null;
        let currentHandle = null;
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        let hasMoved = false;
        let allOfficers = [];

        // ==========================================
        // MODAL LOGIC (Unified)
        // ==========================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            
            // Iframe Reload Fix: Force reload when opening
            const iframe = modal.querySelector('iframe');
            if (iframe) {
                iframe.src = iframe.src; // Reload to ensure fresh state
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ==========================================
        // 1. MEMBERS PRINT LOGIC
        // ==========================================
        async function loadPrintMembers() {
            const dateInput = document.getElementById('printDateInput');
            const listLeft = document.getElementById('printMembersList');

            if (!dateInput) { alert("Please select a date first!"); return; }
            listLeft.innerHTML = "";

            try {
                const response = await fetch(`${API_URL}/api/members/by-date?date=${dateInput.value}`);
                if (!response.ok) throw new Error("Server error");
                
                const members = await response.json();

                if (!members || members.length === 0) {
                    alert("No members found for date: " + dateInput.value);
                    return;
                }

                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id; 
                    option.textContent = member.name; 
                    option.dataset.memberData = JSON.stringify(member);
                    listLeft.appendChild(option);
                });

            } catch (error) {
                console.error("Error loading members:", error);
                alert("Error fetching members.");
            }
        }

        // ==========================================
        // 2. OFFICER LIST LOGIC
        // ==========================================
        const officerSelect = document.getElementById('officerSelect');
        const officerDragItem = document.getElementById('officerDragItem');

        async function initOfficersList() {
            try {
                const response = await fetch(`${API_URL}/get_officers_list`);
                const data = await response.json();
                if (data && Array.isArray(data)) {
                    allOfficers = data;
                    renderOfficerList(data);
                }
            } catch (error) {
                console.error("Error loading officers:", error);
            }
        }

        function renderOfficerList(data) {
            officerSelect.innerHTML = '<option value="">-- Select Officer --</option>';
            data.forEach(off => {
                const option = document.createElement('option');
                option.value = off.id;
                option.textContent = `${off.name_officer} / ${off.designation || 'No Designation'}`;
                officerSelect.appendChild(option);
            });
        }

        function updateDraggableOfficer() {
            const selectedId = officerSelect.value;
            if (selectedId) {
                officerDragItem.style.opacity = '1';
                officerDragItem.style.pointerEvents = 'auto';
            } else {
                officerDragItem.style.opacity = '0.5';
                officerDragItem.style.pointerEvents = 'none';
            }
        }

        // ==========================================
        // 3. ADMIN FORMS LOGIC
        // ==========================================
        const adminSelect = document.getElementById('adminFormsSelect');
        const newFormInput = document.getElementById('newFormName');

        async function initAdminForms() {
            try {
                const response = await fetch(`${API_URL}/get_admin_forms`);
                const data = await response.json();
                
                if (data && Array.isArray(data) && data.length > 0) {
                    renderAdminList(data);
                    console.log("Loaded from Supabase:", data);
                } else {
                    throw new Error("Empty data");
                }
            } catch (error) {
                console.error("Error loading forms:", error);
                console.warn("Using Fallback Data");
                renderAdminList([{ id: 1, forms_name: "Officer Signature" }, { id: 2, forms_name: "Mode of Payment" }, { id: 3, forms_name: "Caption Changer" }]);
            }
        }

        function renderAdminList(data) {
            adminSelect.innerHTML = ''; 
            data.forEach(form => {
                const option = document.createElement('option');
                option.value = form.id; 
                option.textContent = form.forms_name; 
                adminSelect.appendChild(option);
            });
        }

        async function addAdminForm() {
            const name = newFormInput.value.trim();
            if (!name) return alert("Please enter name.");
            try {
                await fetch(`${API_URL}/add_admin_form`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ forms_name: name })
                });
                newFormInput.value = "";
                initAdminForms(); 
            } catch (e) { alert("Error adding"); }
        }

        async function deleteAdminForm() {
            const selectedId = parseInt(adminSelect.value);
            if (!selectedId) return alert("Select a form first.");
            if(confirm("Delete?")) {
                try {
                    await fetch(`${API_URL}/delete_admin_form/${selectedId}`, { method: 'DELETE' });
                    initAdminForms();
                } catch (e) { alert("Error deleting"); }
            }
        }

        function saveAdminForms() {
            alert("Auto-saved on Add/Delete.");
        }

        function checkAdminFormSelection() {
            const selectBox = document.getElementById("adminFormsSelect");
            const selectedOption = selectBox.options[selectBox.selectedIndex];
            
            if (!selectedOption) return;
            const selectedText = selectedOption.textContent; 

            // Logic to open Modals
            if (selectedText === "Officer Signature") {
                openModal('signatureModal');
            } else if (selectedText === "Mode of Payment") {
                openModal('paymentModal');
            } else if (selectedText === "Caption Changer") {
                openModal('captionModal');
            }
        }

        // Initialize on Load
        document.addEventListener('DOMContentLoaded', () => {
            initAdminForms();
            initOfficersList(); 
        });

        // ==========================================
        // 4. DRAG & DROP LOGIC (CANVAS)
        // ==========================================
        const draggables = document.querySelectorAll('.draggable-item');
        draggables.forEach(d => {
            d.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', d.dataset.type);
                e.dataTransfer.setData('caption', d.dataset.caption);
                if(d.dataset.type === 'officer-group') {
                    e.dataTransfer.setData('officerId', officerSelect.value);
                }
            });
        });

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            canvas.style.border = "2px dashed #2563eb";
        });

        canvas.addEventListener('dragleave', (e) => {
            canvas.style.border = "none";
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            canvas.style.border = "none";
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const zoom = parseFloat(zoomSlider.value);
            const actualX = x / zoom;
            const actualY = y / zoom;
            const type = e.dataTransfer.getData('type');
            
            if (type === 'officer-group') {
                const officerId = e.dataTransfer.getData('officerId');
                const officer = allOfficers.find(o => o.id == officerId);
                if (officer) createOfficerElements(officer, actualX, actualY);
            } else {
                const caption = e.dataTransfer.getData('caption');
                createSidebarElement(type, caption, actualX, actualY);
            }
        });

        function createSidebarElement(type, caption, x, y, imgSrc = null) {
            const el = document.createElement('div');
            el.className = 'canvas-element';
            if (imgSrc) {
                el.classList.add('is-image');
                const img = document.createElement('img');
                img.src = imgSrc;
                el.appendChild(img);
                el.style.width = '100px'; el.style.height = '100px';
            } else {
                el.textContent = caption;
                el.style.left = Math.round(x) + 'px';
                el.style.top = Math.round(y) + 'px';
                el.style.fontSize = '12px';
                el.style.fontWeight = 'normal';
                el.style.fontFamily = "'Segoe UI', sans-serif";
                el.style.color = "#1e3a8a"; 
                el.style.padding = '2px 5px';
            }

            if(!imgSrc) {
                el.style.left = Math.round(x) + 'px';
                el.style.top = Math.round(y) + 'px';
            }

            if (type === 'photo') { el.classList.add('is-photo'); el.style.width = '100px'; el.style.height = '120px'; }
            else if (type === 'line') { el.classList.add('is-line'); el.style.width = '150px'; el.textContent = ''; }
            else if (type === 'box' || type === 'sig-box') { el.classList.add('is-box'); el.style.width = '100px'; el.style.height = '40px'; }
            else if (type === 'frosted-box') { el.classList.add('is-frosted'); el.textContent = ''; el.style.width = '150px'; el.style.height = '150px'; }
            else if (!imgSrc) { el.style.width = 'auto'; el.style.whiteSpace = 'nowrap'; }

            el.id = 'field_' + Date.now();
            ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle rh-${pos}`;
                handle.dataset.handle = pos;
                el.appendChild(handle);
            });
            canvas.appendChild(el);
            selectElement(el);
        }

        function createOfficerElements(officer, x, y) {
            // Name
            const nameEl = document.createElement('div');
            nameEl.className = 'canvas-element';
            nameEl.textContent = officer.name_officer;
            nameEl.style.left = Math.round(x) + 'px';
            nameEl.style.top = Math.round(y) + 'px';
            nameEl.style.fontSize = '12px';
            nameEl.style.fontWeight = 'bold';
            nameEl.style.color = "#1e3a8a";
            nameEl.style.width = 'auto';
            nameEl.style.padding = '2px 5px';
            nameEl.style.border = '1px solid #2563eb';
            nameEl.id = 'officer_name_' + officer.id + '_' + Date.now();
            addResizeHandles(nameEl);
            canvas.appendChild(nameEl);
            selectElement(nameEl);

            // Designation
            const desigEl = document.createElement('div');
            desigEl.className = 'canvas-element';
            desigEl.textContent = officer.designation || 'No Designation';
            desigEl.style.left = Math.round(x) + 'px';
            desigEl.style.top = (Math.round(y) + 20) + 'px';
            desigEl.style.fontSize = '11px';
            desigEl.style.color = "#4b5563";
            desigEl.style.width = 'auto';
            desigEl.style.padding = '2px 5px';
            desigEl.style.border = '1px dashed #2563eb';
            desigEl.id = 'officer_desig_' + officer.id + '_' + Date.now();
            addResizeHandles(desigEl);
            canvas.appendChild(desigEl);

            if (officer.man_signature) {
                const sigEl = document.createElement('div');
                sigEl.className = 'canvas-element is-image';
                sigEl.style.left = Math.round(x) + 'px';
                sigEl.style.top = (Math.round(y) + 45) + 'px';
                sigEl.style.width = '100px'; sigEl.style.height = '40px';
                sigEl.id = 'officer_sig_' + officer.id + '_' + Date.now();
                
                const img = document.createElement('img'); img.src = officer.man_signature;
                sigEl.appendChild(img);
                
                addResizeHandles(sigEl);
                canvas.appendChild(sigEl);
            }
        }

        function addResizeHandles(el) {
            ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle rh-${pos}`;
                handle.dataset.handle = pos;
                el.appendChild(handle);
            });
        }

        function addCustomTextbox() {
            const el = document.createElement('div');
            el.className = 'custom-textbox';
            el.contentEditable = "true";
            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;
            el.style.left = (canvasWidth / 2 - 100) + 'px'; 
            el.style.top = (canvasHeight / 2 - 10) + 'px';
            el.style.width = '200px'; 
            el.innerText = "";
            el.id = 'custom_' + Date.now();
            ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle rh-${pos}`;
                el.appendChild(handle);
            });
            canvas.appendChild(el);
            selectElement(el);
            setTimeout(function() { el.focus(); }, 100);
        }

        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const img = new Image();
                    img.onload = function() {
                        canvas.style.width = img.width + 'px';
                        canvas.style.height = img.height + 'px';
                        canvas.style.backgroundImage = `url('${evt.target.result}')`;
                        filenameSpan.textContent = "Template: " + file.name;
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        logoUploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    createSidebarElement('logo-image', 'Logo', 50, 50, evt.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // ==========================================
        // 5. ZOOM LOGIC
        // ==========================================
        zoomSlider.addEventListener('input', function() {
            const scale = this.value;
            zoomValue.textContent = Math.round(scale * 100) + '%';
            const allCanvases = document.querySelectorAll('.workspace .canvas-wrapper');
            allCanvases.forEach(c => {
                c.style.transform = `scale(${scale})`;
            });
        });

        // ==========================================
        // 6. MOUSE EVENTS (Drag, Resize, Select)
        // ==========================================
        document.addEventListener('mousedown', function(e) {
            hasMoved = false;
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                currentHandle = e.target.dataset.handle;
                currentEl = e.target.parentElement;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(getComputedStyle(currentEl).width);
                startHeight = parseInt(getComputedStyle(currentEl).height);
                startLeft = parseInt(getComputedStyle(currentEl).left);
                startTop = parseInt(getComputedStyle(currentEl).top);
                selectElement(currentEl);
                e.stopPropagation();
                return;
            }
            const targetEl = e.target.closest('.canvas-element') || e.target.closest('.custom-textbox');
            if (targetEl) {
                currentEl = targetEl;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = currentEl.offsetLeft;
                startTop = currentEl.offsetTop;
                if (currentEl.classList.contains('custom-textbox')) {
                    const dragTimer = setTimeout(() => {
                        isDragging = true;
                        selectElement(currentEl);
                    }, 150); 
                    currentEl.dataset.dragTimer = dragTimer;
                } else {
                    isDragging = true;
                    selectElement(currentEl);
                }
            } else if (!e.target.closest('.toolbar') && !e.target.closest('.sidebar') && !e.target.closest('.admin-forms-panel') && !e.target.closest('.modal-content')) {
                deselectAll();
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (isResizing && currentEl) {
                e.preventDefault();
                const zoom = parseFloat(zoomSlider.value);
                const dx = (e.clientX - startX) / zoom;
                const dy = (e.clientY - startY) / zoom;
                if (currentHandle.includes('e')) currentEl.style.width = Math.round(startWidth + dx) + 'px';
                if (currentHandle.includes('s')) currentEl.style.height = Math.round(startHeight + dy) + 'px';
            }
            else if (isDragging && currentEl) {
                hasMoved = true;
                e.preventDefault();
                const zoom = parseFloat(zoomSlider.value);
                const dx = (e.clientX - startX) / zoom;
                const dy = (e.clientY - startY) / zoom;
                currentEl.style.left = Math.round(startLeft + dx) + 'px';
                currentEl.style.top = Math.round(startTop + dy) + 'px';
            }
        });

        document.addEventListener('mouseup', function() {
            if (currentEl && currentEl.dataset.dragTimer) {
                clearTimeout(currentEl.dataset.dragTimer);
                delete currentEl.dataset.dragTimer;
            }
            isDragging = false;
            isResizing = false;
            currentEl = null;
            currentHandle = null;
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                const selected = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
                if (selected) {
                    let left = parseInt(selected.style.left || 0);
                    let top = parseInt(selected.style.top || 0);
                    const moveStep = 1; 
                    if (e.key === 'ArrowUp') { top -= moveStep; e.preventDefault(); }
                    if (e.key === 'ArrowDown') { top += moveStep; e.preventDefault(); }
                    if (e.key === 'ArrowLeft') { left -= moveStep; e.preventDefault(); }
                    if (e.key === 'ArrowRight') { left += moveStep; e.preventDefault(); }
                    selected.style.left = left + 'px';
                    selected.style.top = top + 'px';
                }
            }
        });

        function selectElement(el) {
            deselectAll();
            el.classList.add('selected');
            let currentSize = 12;
            let currentWeight = 'normal';
            let currentFamily = "'Segoe UI', sans-serif";
            let currentColor = "#000";
            let currentRotate = 0;

            const computed = getComputedStyle(el);
            if(computed.fontSize) currentSize = parseInt(computed.fontSize); 
            if(computed.fontWeight) currentWeight = computed.fontWeight;
            if(computed.fontFamily) currentFamily = computed.fontFamily;
            currentColor = el.style.color || "#000"; 

            // Extract rotation from inline style
            const transform = el.style.transform;
            if (transform && transform.includes('rotate')) {
                const match = transform.match(/rotate\(([^)]+)deg\)/);
                if (match) currentRotate = match[1];
            }
            
            propSize.value = currentSize;
            propFont.value = currentWeight;
            propFontFamily.value = currentFamily;
            if(currentColor.startsWith('#')) propTextColor.value = currentColor;
            
            // UPDATE: Sync both Slider and Textbox
            propRotate.value = currentRotate;
            propRotateText.value = currentRotate;
        }

        function deselectAll() {
            document.querySelectorAll('.canvas-element, .custom-textbox').forEach(el => {
                el.classList.remove('selected');
            });
        }

        // Toolbar Helpers
        propSize.addEventListener('input', () => {
            const sel = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
            if(sel) sel.style.fontSize = propSize.value + 'px';
        });
        propFont.addEventListener('change', () => {
            const sel = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
            if(sel) sel.style.fontWeight = propFont.value;
        });
        propFontFamily.addEventListener('change', () => {
            const sel = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
            if(sel) sel.style.fontFamily = propFontFamily.value;
        });
        propTextColor.addEventListener('input', () => {
            const sel = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
            if(sel) sel.style.color = propTextColor.value;
        });

        // UPDATED: Rotation Event Listeners (Slider & Textbox Sync)
        function updateRotation(deg) {
            const sel = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
            if (sel) {
                sel.style.transform = 'rotate(' + deg + 'deg)';
                // Sync inputs
                propRotate.value = deg;
                propRotateText.value = deg;
            }
        }

        propRotate.addEventListener('input', () => {
            updateRotation(propRotate.value);
        });

        propRotateText.addEventListener('input', () => {
            updateRotation(propRotateText.value);
        });

        // Helper function for buttons
        function setRotate(deg) {
            const sel = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
            if (sel) {
                sel.style.transform = 'rotate(' + deg + 'deg)';
                propRotate.value = deg;
                propRotateText.value = deg;
            } else {
                alert("Please select an element first.");
            }
        }

        function deleteSelected() {
            const selected = document.querySelector('.canvas-element.selected, .custom-textbox.selected');
            if (selected) {
                selected.remove();
            } else {
                alert("Please select an item on canvas first to delete it.");
            }
        }

        // ==========================================
        // 7. SAVE & LOAD LOGIC (TEMPLATE)
        // ==========================================
        async function saveLayout() {
            const elements = [];
            Array.from(canvas.children).forEach(child => {
                if (child.classList.contains('resize-handle')) return; 
                
                const isLine = child.classList.contains('is-line');
                let h = parseInt(getComputedStyle(child).height);
                if (isLine) h = ""; 

                const data = {
                    className: child.className,
                    id: child.id,
                    text: child.innerText,
                    left: child.style.left,
                    top: child.style.top,
                    width: child.style.width,
                    height: h,
                    color: child.style.color,
                    fontSize: child.style.fontSize,
                    fontFamily: child.style.fontFamily,
                    fontWeight: child.style.fontWeight,
                    transform: child.style.transform,
                    isContentEditable: child.isContentEditable
                };
                const img = child.querySelector('img');
                if (img) data.imgSrc = img.src;
                
                elements.push(data);
            });
            const payload = {
                template: {
                    backgroundImage: canvas.style.backgroundImage,
                    width: canvas.style.width,
                    height: canvas.style.height
                },
                fields: elements
            };
            try {
                const response = await fetch(`${API_URL}/save_layout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (response.ok) alert(result.message || "Layout Saved Successfully!");
                else alert("Error saving: " + result.message);
            } catch (e) { console.error("Save error:", e); alert("Failed to connect to server."); }
        }

        async function loadLayout() {
            try {
                Array.from(canvas.children).forEach(child => child.remove());

                const response = await fetch(`${API_URL}/load_layout`);
                const result = await response.json();
                if (!response.ok) {
                    alert("Error loading: " + result.message);
                    return;
                }
                const saved = result.data;

                if (saved && saved.template) {
                    canvas.style.backgroundImage = saved.template.backgroundImage;
                    canvas.style.width = saved.template.width;
                    canvas.style.height = saved.template.height;
                }

                if (saved && saved.fields) {
                    saved.fields.forEach(fieldData => {
                        const el = document.createElement('div');
                        el.className = fieldData.className;
                        el.id = fieldData.id;
                        el.style.left = fieldData.left;
                        el.style.top = fieldData.top;
                        el.style.width = fieldData.width;
                        el.style.color = fieldData.color;
                        el.style.fontSize = fieldData.fontSize;
                        el.style.fontFamily = fieldData.fontFamily;
                        el.style.fontWeight = fieldData.fontWeight;
                        
                        // Restore Rotation
                        if (fieldData.transform) {
                            el.style.transform = fieldData.transform;
                        }

                        if (!fieldData.height || fieldData.height === '' || fieldData.height === '0px') {
                            el.style.height = "";
                        } else {
                            el.style.height = fieldData.height;
                        }

                        if (fieldData.className.includes('is-line')) {
                            el.innerText = "";
                        } else {
                            el.innerText = fieldData.text;
                        }
                        
                        if (fieldData.imgSrc) {
                            el.innerHTML = `<img src="${fieldData.imgSrc}" style="width:100%; height:100%; object-fit:contain; pointer-events:none;">`;
                        }
                        
                        if (fieldData.selectValue) {
                            const sel = document.createElement('select');
                            sel.style.width = '100%';
                            sel.style.height = '100%';
                            sel.value = fieldData.selectValue;
                            el.innerText = "";
                            el.appendChild(sel);
                        }
                        if (fieldData.inputValue) {
                            const inp = document.createElement('input');
                            inp.type = 'number';
                            inp.style.width = '100%';
                            inp.style.height = '100%';
                            inp.value = fieldData.inputValue;
                            el.innerText = "";
                            el.appendChild(inp);
                        }

                        ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                            const handle = document.createElement('div');
                            handle.className = `resize-handle rh-${pos}`;
                            handle.dataset.handle = pos;
                            el.appendChild(handle);
                        });
                        canvas.appendChild(el);
                    });
                }
                alert("Layout Loaded Successfully!");
            } catch (error) {
                console.error("Load error:", error);
                alert("Failed to connect to server.");
            }
        }

        // ==========================================
        // 8. LOAD & MERGE LOGIC
        // ==========================================
        
        const MERGE_KEYWORDS = [
            "FULL NAME", "PSEUDO NAME", "ID NUMBER", "BLOOD TYPE",
            "DATE ISSUED", "VALID UNTIL", "ADDRESS", "HOME ADDRESS",
            "CONTACT NO", "CONTACT NUMBER",
            "CHAPTER", "HEIGHT", "WEIGHT", "OCCUPATION",
            "EMERGENCY NAME", "EMERGENCY PERSON NAME",
            "EMERGENCY ADDRESS",
            "EMERGENCY CONTACT", "EMERGENCY NO", "EMERGENCY CONTACT NO",
            "BIRTHDATE", "CIVIL STATUS", "DESIGNATION", "PHOTO", "SIGNATURE", "QR CODE", "OR CODES"
        ];

        async function loadAndMergeLayout() {
            try {
                const response = await fetch(`${API_URL}/load_layout`);
                const result = await response.json();
                if (!response.ok) {
                    alert("Error: " + result.message);
                    return;
                }
                const saved = result.data;
                if (!saved) {
                    alert("No saved layout found.");
                    return;
                }

                const selectedOptions = document.getElementById('printMembersList').options;
                
                if (selectedOptions.length === 0) {
                    alert("Please select members in 'SELECT TO PRINT' listbox first!");
                    return;
                }

                workspace.innerHTML = "";

                for (let i = 0; i < selectedOptions.length; i++) {
                    const option = selectedOptions[i];
                    const member = JSON.parse(option.dataset.memberData);
                    
                    const newCanvas = document.createElement('div');
                    newCanvas.className = 'canvas-wrapper';
                    newCanvas.style.width = saved.template.width;
                    newCanvas.style.height = saved.template.height;
                    newCanvas.style.backgroundImage = saved.template.backgroundImage;
                    newCanvas.style.backgroundRepeat = "no-repeat";
                    newCanvas.style.backgroundSize = "contain";
                    newCanvas.style.boxShadow = "0 10px 40px rgba(0,0,0,0.2)";
                    
                    const zoom = parseFloat(zoomSlider.value);
                    newCanvas.style.transform = `scale(${zoom})`;

                    workspace.appendChild(newCanvas);

                    if (saved && saved.fields) {
                        saved.fields.forEach(fieldData => {
                            const el = document.createElement('div');
                            el.className = fieldData.className;
                            el.id = fieldData.id + '_' + i;
                            el.style.left = fieldData.left;
                            el.style.top = fieldData.top;
                            el.style.width = fieldData.width;
                            
                            if (fieldData.height && fieldData.height !== '' && fieldData.height !== '0px') {
                                el.style.height = fieldData.height;
                            } else {
                                el.style.height = ""; 
                            }

                            el.style.color = fieldData.color;
                            el.style.fontSize = fieldData.fontSize;
                            el.style.fontFamily = fieldData.fontFamily;
                            el.style.fontWeight = fieldData.fontWeight;
                            el.style.borderColor = "transparent";

                            // Restore Rotation for Printed Cards
                            if (fieldData.transform) {
                                el.style.transform = fieldData.transform;
                            }

                            const fieldText = (fieldData.text || "").trim().toUpperCase();
                            const isCssObject = fieldData.className.includes('is-line') || 
                                                    fieldData.className.includes('is-box') || 
                                                    fieldData.className.includes('is-frosted');
                            const isOfficer = fieldData.id.includes("officer_");

                            if (isOfficer) {
                                if (fieldData.imgSrc) {
                                    el.innerHTML = "";
                                    const img = document.createElement('img');
                                    img.src = fieldData.imgSrc;
                                    img.style.width = '100%'; img.style.height = '100%';
                                    img.style.objectFit = 'contain'; img.style.pointerEvents = 'none';
                                    el.appendChild(img);
                                } else {
                                    if (fieldData.className.includes('is-line')) el.innerText = "";
                                    else el.innerText = fieldData.text;
                                }
                            }
                            else if (isCssObject) {
                                if (fieldData.className.includes('is-line')) el.innerText = "";
                                else el.innerText = fieldData.text;
                            }
                            else if (fieldData.imgSrc) {
                                const img = document.createElement('img');
                                img.src = fieldData.imgSrc;
                                img.style.width = '100%'; img.style.height = '100%';
                                img.style.objectFit = 'contain'; img.style.pointerEvents = 'none';
                                el.innerHTML = ''; el.appendChild(img);
                            }
                            else if (MERGE_KEYWORDS.includes(fieldText)) {
                                const dataVal = getMemberValue(fieldData.text, member);

                                if (isImageField(fieldData.text)) {
                                    el.innerHTML = "";
                                    const img = document.createElement('img');
                                    
                                    if (fieldText === "PHOTO") img.src = member.photo_data || "";
                                    else if (fieldText === "SIGNATURE") img.src = member.signature || "";
                                    else if (fieldText === "QR CODE" || fieldText === "OR CODES") img.src = member.qr_code || "";
                                    else img.src = ""; 

                                    img.style.width = '100%'; img.style.height = '100%';
                                    img.style.objectFit = 'contain';
                                    el.appendChild(img);
                                } else {
                                    el.innerText = dataVal;
                                }
                            }
                            else {
                                if (fieldData.selectValue) {
                                    el.innerHTML = "";
                                    const sel = document.createElement('select');
                                    sel.style.width = '100%';
                                    sel.style.height = '100%';
                                    sel.style.background = 'rgba(255,255,255,0.8)';
                                    sel.style.border = '1px dashed #10b981';
                                    
                                    el.innerText = member.name; 
                                    el.style.fontWeight = 'bold';
                                }
                                else if (fieldData.inputValue) {
                                    el.innerHTML = "";
                                    const inp = document.createElement('input');
                                    inp.type = 'number';
                                    inp.value = i + 1; 
                                    inp.style.width = '100%';
                                    inp.style.height = '100%';
                                    inp.style.background = 'rgba(255,255,255,0.8)';
                                    inp.style.border = '1px dashed #94a3b8';
                                    inp.style.textAlign = 'center';
                                    el.appendChild(inp);
                                }
                                else {
                                    el.innerText = fieldData.text;
                                }
                            }
                            
                            newCanvas.appendChild(el);
                        });
                    }
                }
                statusMsg = `Generated ID for ${selectedOptions.length} member(s).`;
            } catch (e) {
                console.error("Merge Error:", e);
                alert("Failed to load.");
            }
        }

        // ==========================================
        // 9. HELPERS
        // ==========================================
        function getMemberValue(caption, member) {
            const cap = caption.trim().toUpperCase();
            if (cap === "FULL NAME") return member.name || "";
            if (cap === "PSEUDO NAME") return member.pseudo_name || "";
            if (cap === "ID NUMBER") return member.idnumb || "";
            if (cap === "DESIGNATION") return member.designation || ""; 
            if (cap === "BLOOD TYPE") return member.blood_type || "";
            if (cap === "ADDRESS" || cap === "HOME ADDRESS") return member.home_address || "";
            if (cap === "EMERGENCY ADDRESS") return member.home_address || "";
            if (cap === "CONTACT NO" || cap === "CONTACT NUMBER") return member.contact_no || "";
            if (cap === "EMERGENCY NO" || cap === "EMERGENCY CONTACT NO" || cap === "EMERGENCY CONTACT") return member.emergency_contact_no || "";
            if (cap === "DATE ISSUED") return member.issued_date || "";
            if (cap === "VALID UNTIL") return member.valid_until || "";
            if (cap === "CHAPTER") return member.chapter || "";
            if (cap === "HEIGHT") return member.height || "";
            if (cap === "WEIGHT") return member.weight || "";
            if (cap === "OCCUPATION") return member.occupation || "";
            if (cap === "EMERGENCY NAME" || cap === "EMERGENCY PERSON NAME") return member.emergency_person_name || "";
            if (cap === "BIRTHDATE") return member.birthdate || "";
            if (cap === "CIVIL STATUS") return member.civil_status || "";
            return "";
        }

        function isImageField(caption) {
            const cap = caption.trim().toUpperCase();
            return (cap === "PHOTO" || cap === "SIGNATURE" || cap === "QR CODE" || cap === "OR CODES");
        }

    </script>
</body>
</html>
