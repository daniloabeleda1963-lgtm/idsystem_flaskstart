<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID PDF Generator - Clean & Merge</title>
    
    <!-- PDF GENERATION LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* GLOBAL RESET */
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- SIDEBAR (ISKO CLEAN) --- */
        .sidebar {
            width: 280px; background: var(--sidebar-bg); color: var(--sidebar-text);
            display: flex; flex-direction: column; border-right: 1px solid #334155;
            z-index: 200; overflow-y: auto;
        }
        .sidebar-header { padding: 15px; background: #0f172a; font-weight: bold; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;}
        
        /* PANELS */
        .panel { padding: 10px; border-bottom: 1px solid #334155; }
        .panel-title { font-size: 11px; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; font-weight: bold; }
        
        /* CONTROLS */
        input[type="date"], select, .admin-btn, .listbox-select {
            width: 100%; padding: 6px; margin-bottom: 5px;
            background: #334155; color: white; border: none; border-radius: 4px; box-sizing: border-box;
        }
        .admin-btn { background: #2563eb; cursor: pointer; font-weight: bold; }
        .admin-btn:hover { background: #1d4ed8; }
        
        /* TRANSFER LIST */
        .transfer-box { display: flex; gap: 4px; height: 150px; }
        .list-col { flex: 1; display: flex; flex-direction: column; }
        .btn-col { width: 30px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
        .transfer-btn {
            width: 100%; height: 28px; background: #475569; color: white;
            border: none; cursor: pointer; font-size: 14px; font-weight: bold;
        }
        .transfer-btn:hover { background: #64748b; }
        .listbox-select { height: 100%; font-size: 11px; overflow: auto; }
        .list-label { font-size: 10px; color: #94a3b8; text-align: center; margin-bottom: 2px; }

        /* DRAGGABLES */
        .draggable-item {
            background: #334155; padding: 8px; margin-bottom: 5px; border-radius: 4px;
            cursor: grab; font-size: 13px; border: 1px solid #475569;
        }
        .draggable-item:hover { background: #475569; border-color: var(--primary-color); }

        /* --- MAIN AREA --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        
        .toolbar {
            background: white; padding: 8px 20px; border-bottom: 1px solid #ddd;
            display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap;
        }
        .toolbar-group { display: flex; gap: 8px; align-items: center; }
        
        button {
            padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px;
            cursor: pointer; font-size: 12px;
        }
        button:hover { background: #f9fafb; }
        button.primary { background: var(--primary-color); color: white; border: none; }
        button.danger { background: #ef4444; color: white; border: none; }
        button.success { background: #10b981; color: white; border: none; }
        button.warning { background: #f59e0b; color: white; border: none; }

        /* WORKSPACE */
        .workspace {
            flex-grow: 1; background: #e5e7eb; overflow: auto;
            display: flex; flex-direction: column; align-items: center; padding: 50px; gap: 20px;
        }
        .canvas-wrapper {
            position: relative; background-color: #fff; width: 800px; height: 400px;
            background-repeat: no-repeat; background-size: contain; background-position: top left;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); user-select: none; flex-shrink: 0;
            transform-origin: top center;
        }

        /* ELEMENTS (WORDPAD STYLE CENTERING - FINAL VERSION) */
        .canvas-element {
            position: absolute; cursor: move; background: transparent; 
            border: none; 
            color: #1e3a8a; font-size: 12px; font-weight: bold;
            
            /* CRITICAL CENTERING STYLES */
            display: flex; /* Enables Flexbox Centering */
            align-items: center; /* Vertically Centers Text (Fixes 'Malayo ng itaas') */
            justify-content: center; /* Horizontally Centers Text (Fixes 'Hindi gitna') */
            text-align: center; /* Internal Text Alignment */
            
            z-index: 100; overflow: hidden;
        }
        /* Selection Style */
        .canvas-element.selected { 
            border: 2px solid var(--primary-color) !important; 
            background: rgba(37, 99, 235, 0.3); 
            z-index: 101; 
        }
        
        .canvas-element.is-line { 
            background: transparent; 
            border: none; /* Reset general border */
            border-bottom: 2px solid black; /* Apply specific border */
            height: 0px !important; min-height: 2px; 
        }
        
        .canvas-element.is-box { background: transparent; border: none; }
        .canvas-element.is-image { background: transparent; border: none; display: flex; align-items: center; justify-content: center; }
        .canvas-element.is-photo { background: transparent; border: none; }
        
        .canvas-element img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        .custom-textbox {
            position: absolute; background: transparent; border: 1px dashed #94a3b8;
            color: #000; font-size: 14px; font-family: 'Segoe UI', sans-serif;
            z-index: 200; min-width: 200px; min-height: 20px; cursor: text;
            padding: 4px; outline: none; white-space: pre-wrap; text-align: center;
        }
        .custom-textbox.selected { border: 2px solid var(--primary-color); cursor: move; }

        .resize-handle {
            position: absolute; width: 8px; height: 8px; background: white;
            border: 1px solid var(--primary-color); display: none; z-index: 300;
        }
        .selected .resize-handle { display: block; }
        .rh-se { bottom: -4px; right: -4px; cursor: nwse-resize; }
        .rh-sw { bottom: -4px; left: -4px; cursor: nesw-resize; }
        .rh-ne { top: -4px; right: -4px; cursor: nesw-resize; }
        .rh-nw { top: -4px; left: -4px; cursor: nwse-resize; }

        /* --- MOBILE SLIDING SIDEBAR (CURTAIN EFFECT) --- */
        #mobileMenuBtn {
            display: none;
            font-size: 18px;
            padding: 6px 12px;
            background: #1e293b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #closeSidebarBtn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #closeSidebarBtn:hover { color: white; }

        @media (max-width: 768px) {
            #mobileMenuBtn { display: block; }
            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                height: 100%;
                width: 280px;
                transition: left 0.3s ease-in-out;
                z-index: 9999;
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            .sidebar.active { left: 0; }
            .toolbar { padding: 8px 10px; gap: 5px; }
            .toolbar-group { flex-wrap: wrap; justify-content: center; }
            .workspace { padding: 10px; }
            .canvas-wrapper { transform-origin: top left; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR: CLEAN & TIDY -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            ID Generator
            <button id="closeSidebarBtn">‚úñ</button>
        </div>

        <!-- 1. MEMBERS PANEL -->
        <div class="panel">
            <div class="panel-title">MEMBERS DATA</div>
            <input type="date" id="issueDateInput">
            <button class="admin-btn" onclick="loadMembers()">üë• Load Members</button>
            
            <div class="transfer-box">
                <div class="list-col">
                    <div class="list-label">DB List</div>
                    <select id="listLeft" class="listbox-select" multiple></select>
                </div>
                <div class="btn-col">
                    <button class="transfer-btn" onclick="moveRight()">&gt;</button>
                    <button class="transfer-btn" onclick="moveAllRight()">&gt;&gt;</button>
                    <button class="transfer-btn" onclick="moveLeft()">&lt;</button>
                    <button class="transfer-btn" onclick="moveAllLeft()">&lt;&lt;</button>
                </div>
                <div class="list-col">
                    <div class="list-label">Selected</div>
                    <select id="listRight" class="listbox-select" multiple></select>
                </div>
            </div>
        </div>

        <!-- 2. OFFICERS PANEL -->
        <div class="panel">
            <div class="panel-title">OFFICERS LIST</div>
            <select id="officerSelect" onchange="updateDraggableOfficer()">
                <option value="">-- Select Officer --</option>
            </select>
            <div id="officerDragItem" class="draggable-item" draggable="true" 
                 data-type="officer-group" style="opacity: 0.5; pointer-events: none; margin-top: 5px;">
                üë§ Drag Officer
            </div>
        </div>

        <!-- 3. TOOLBOX (SIMPLIFIED + EMERGENCY) -->
        <div class="panel" style="flex-grow: 1;">
            <div class="panel-title">TOOLS</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="FULL NAME">Full Name</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="ID NUMBER">ID Number</div>
            <div class="draggable-item" draggable="true" data-type="text" data-caption="CHAPTER">Chapter</div>
            <div class="draggable-item" draggable="true" data-type="photo" data-caption="PHOTO">Photo Box</div>
            <div class="draggable-item" draggable="true" data-type="sig-box" data-caption="SIGNATURE">Signature Box</div>
            <div class="draggable-item" draggable="true" data-type="qr-code" data-caption="QR CODE">QR Code Box</div>
            <div class="draggable-item" draggable="true" data-type="line" data-caption="Line">Line</div>
            <div class="draggable-item" draggable="true" data-type="box" data-caption="Box">Box</div>
            
            <!-- EMERGENCY TOOLS -->
            <div style="margin-top: 10px; border-top: 1px solid #475569; padding-top: 5px;">
                <div class="panel-title" style="margin-bottom: 5px;">EMERGENCY</div>
                <div class="draggable-item" draggable="true" data-type="text" data-caption="EMERGENCY PERSON NAME">Emgy. Name</div>
                <div class="draggable-item" draggable="true" data-type="text" data-caption="EMERGENCY ADDRESS">Emgy. Address</div>
                <div class="draggable-item" draggable="true" data-type="text" data-caption="EMERGENCY CONTACT">Emgy. Contact</div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="mainContent">
        <div class="toolbar">
            <div class="toolbar-group">
                <button id="mobileMenuBtn">‚ò∞</button>

                <label class="primary" style="padding:6px 12px; cursor:pointer; border-radius:4px; background:#6366f1; color:white;">
                    üìÅ Template
                    <input type="file" id="templateUpload" accept="image/*" style="display:none;">
                </label>
                <button class="warning" onclick="addCustomTextbox()">‚ûï Text</button>
                <span id="statusMsg" style="font-size: 12px; color: #666;">Ready</span>
            </div>

            <div class="toolbar-group">
                <!-- ZOOM -->
                <span style="font-size: 12px;">Zoom:</span>
                <input type="range" id="zoomSlider" min="0.3" max="2.0" step="0.1" value="1.0">
                <span id="zoomValue" style="font-size: 12px; width: 35px;">100%</span>

                <div style="border-left: 1px solid #ddd; padding-left: 10px; display: flex; gap: 5px;">
                    <select id="propFontFamily" style="width: 100px; padding: 4px;">
                        <option value="'Segoe UI', sans-serif">Segoe UI</option>
                        <option value="Arial, sans-serif">Arial</option>
                    </select>
                    <input type="color" id="propTextColor" value="#000000" style="width: 30px; padding: 0;">
                    <input type="number" id="propSize" value="12" style="width: 40px; padding: 4px;">
                </div>

                <button class="danger" onclick="deleteSelected()">üóëÔ∏è</button>
                
                <!-- CORE ACTIONS -->
                <button class="primary" onclick="saveLayout()">üíæ Save</button>
                <button class="primary" style="background:#8b5cf6;" onclick="loadAndMergeLayout()">üîÑ Load & Merge</button>
                
                <!-- EXPORTS -->
                <button class="primary" onclick="downloadPDF()">üìÑ PDF</button>
                <button class="warning" onclick="downloadFirstCardScreenshot()">üì∏ Img</button>
                <button class="success" onclick="exportForPhone()">üì± Phone</button>
                
                <!-- BUCKET ACTIONS -->
                <button class="success" style="background:#10b981;" onclick="saveCardToSupabase()">‚òÅÔ∏è Save Card</button>
                <button class="danger" style="background:#dc2626;" onclick="deleteBatchCards()">üßπ Clear IDs</button>
                <button class="warning" style="background:#f97316;" onclick="openViewPhone()">üëÅÔ∏è View</button>
            </div>
        </div>

        <div class="workspace">
            <div class="canvas-wrapper" id="editorCanvas"></div>
        </div>
    </div>

    <script>
        const API_URL = ''; 
        const statusMsg = document.getElementById('statusMsg');
        const workspace = document.querySelector('.workspace');
        const canvas = document.getElementById('editorCanvas');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        const propSize = document.getElementById('propSize');
        const propFontFamily = document.getElementById('propFontFamily');
        const propTextColor = document.getElementById('propTextColor');
        
        let isDragging = false, isResizing = false, currentEl = null, currentHandle = null;
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        let allOfficers = [];

        // --- 0. MOBILE MENU LOGIC ---
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn'); 
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        mobileMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            sidebar.classList.toggle('active');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('active');
        });

        mainContent.addEventListener('click', () => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        // --- 0.1 ARROW KEY NAVIGATION ---
        document.addEventListener('keydown', (e) => {
            const selected = document.querySelector('.selected');
            if (!selected) return;
            if (selected.isContentEditable) return;
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;

            const shift = e.shiftKey ? 10 : 1; 
            let x = parseInt(selected.style.left) || 0;
            let y = parseInt(selected.style.top) || 0;
            let moved = false;

            if (e.key === 'ArrowLeft') { x -= shift; moved = true; }
            if (e.key === 'ArrowRight') { x += shift; moved = true; }
            if (e.key === 'ArrowUp') { y -= shift; moved = true; }
            if (e.key === 'ArrowDown') { y += shift; moved = true; }

            if (moved) {
                selected.style.left = x + 'px';
                selected.style.top = y + 'px';
                e.preventDefault(); 
            }
        });

        // --- 1. MEMBERS LOGIC ---
        async function loadMembers() {
            const dateInput = document.getElementById('issueDateInput').value;
            const listLeft = document.getElementById('listLeft');
            if (!dateInput) return alert("Select a date first.");
            
            listLeft.innerHTML = ""; statusMsg.textContent = "Loading...";
            try {
                const res = await fetch(`${API_URL}/api/members/by-date?date=${dateInput}`);
                const members = await res.json();
                if(!members.length) return alert("No members found.");
                
                members.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id; opt.textContent = m.name;
                    opt.dataset.memberData = JSON.stringify(m);
                    listLeft.appendChild(opt);
                });
                statusMsg.textContent = `Loaded ${members.length} members.`;
            } catch(e) { console.error(e); alert("Error loading members."); }
        }

        const listLeftElem = document.getElementById('listLeft');
        const listRightElem = document.getElementById('listRight');

        function moveRight() { moveSelected(listLeftElem, listRightElem); }
        function moveAllRight() { moveAll(listLeftElem, listRightElem); }
        function moveLeft() { moveSelected(listRightElem, listLeftElem); }
        function moveAllLeft() { moveAll(listRightElem, listLeftElem); }

        function moveSelected(from, to) { Array.from(from.selectedOptions).forEach(o => to.add(o)); }
        function moveAll(from, to) { Array.from(from.options).forEach(o => to.add(o)); }

        // --- 2. OFFICER LOGIC ---
        async function initOfficers() {
            try {
                const res = await fetch(`${API_URL}/get_officers_list`);
                allOfficers = await res.json();
                const sel = document.getElementById('officerSelect');
                allOfficers.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.id; opt.textContent = `${o.name_officer} / ${o.designation || ''}`;
                    sel.appendChild(opt);
                });
            } catch(e) { console.error(e); }
        }
        function updateDraggableOfficer() {
            const val = document.getElementById('officerSelect').value;
            const el = document.getElementById('officerDragItem');
            el.style.opacity = val ? '1' : '0.5';
            el.style.pointerEvents = val ? 'auto' : 'none';
        }

        // --- 3. CANVAS & DRAG DROP ---
        document.querySelectorAll('.draggable-item').forEach(d => {
            d.addEventListener('dragstart', e => {
                e.dataTransfer.setData('type', d.dataset.type);
                e.dataTransfer.setData('caption', d.dataset.caption);
                if(d.dataset.type === 'officer-group') e.dataTransfer.setData('officerId', document.getElementById('officerSelect').value);
            });
        });

        canvas.addEventListener('dragover', e => { e.preventDefault(); canvas.style.border = "2px dashed blue"; });
        canvas.addEventListener('dragleave', e => { canvas.style.border = "none"; });
        canvas.addEventListener('drop', e => {
            e.preventDefault(); canvas.style.border = "none";
            const rect = canvas.getBoundingClientRect();
            const zoom = parseFloat(zoomSlider.value);
            const x = (e.clientX - rect.left) / zoom;
            const y = (e.clientY - rect.top) / zoom;
            const type = e.dataTransfer.getData('type');
            
            if (type === 'officer-group') {
                const off = allOfficers.find(o => o.id == e.dataTransfer.getData('officerId'));
                if(off) createOfficerGroup(off, x, y);
            } else {
                createSidebarElement(type, e.dataTransfer.getData('caption'), x, y);
            }
        });

        function createSidebarElement(type, caption, x, y) {
            const el = document.createElement('div');
            el.className = 'canvas-element';
            el.textContent = caption;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            
            el.style.textAlign = 'center';
            el.style.boxSizing = 'border-box';

            if(type === 'photo') { 
                el.classList.add('is-photo'); 
                el.style.width = '100px'; el.style.height = '120px'; 
                el.style.border = 'none'; 
            }
            else if(type === 'sig-box' || type === 'qr-code') { 
                el.classList.add('is-box'); 
                el.style.width = '80px'; el.style.height = '40px'; 
                el.style.border = 'none'; 
            }
            else if(type === 'line') { el.classList.add('is-line'); el.style.width = '150px'; el.textContent = ''; }
            else if(type === 'box') { 
                el.classList.add('is-box'); 
                el.style.width = '100px'; el.style.height = '50px'; 
                el.style.border = 'none'; 
            }
            else { 
                // DEFAULT SIZE FOR TEXT BOXES (Uniform Size)
                el.style.width = '200px';
                el.style.height = '40px'; 
                el.style.padding = '2px 5px'; 
            }
            
            el.id = 'el_' + Date.now();
            addResizeHandles(el); canvas.appendChild(el); selectElement(el);
        }

        function createOfficerGroup(off, x, y) {
            // Name
            let el = document.createElement('div'); el.className = 'canvas-element'; el.textContent = off.name_officer;
            el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.fontWeight = 'bold';
            el.style.textAlign = 'center'; el.style.boxSizing = 'border-box';
            addResizeHandles(el); canvas.appendChild(el);
            // Designation
            el = document.createElement('div'); el.className = 'canvas-element'; el.textContent = off.designation;
            el.style.left = x + 'px'; el.style.top = (y + 20) + 'px'; el.style.fontSize = '11px';
            el.style.textAlign = 'center'; el.style.boxSizing = 'border-box';
            addResizeHandles(el); canvas.appendChild(el);
            // Signature
            if(off.man_signature) {
                el = document.createElement('div'); el.className = 'canvas-element is-image';
                el.style.left = x + 'px'; el.style.top = (y + 40) + 'px'; el.style.width = '100px'; el.style.height = '40px';
                el.style.boxSizing = 'border-box';
                el.style.border = 'none'; 
                el.innerHTML = `<img src="${off.man_signature}">`; addResizeHandles(el); canvas.appendChild(el);
            }
        }

        function addResizeHandles(el) {
            ['nw', 'ne', 'sw', 'se'].forEach(p => {
                const h = document.createElement('div'); h.className = `resize-handle rh-${p}`; h.dataset.handle = p; el.appendChild(h);
            });
        }

        function addCustomTextbox() {
            const el = document.createElement('div');
            el.className = 'custom-textbox'; el.contentEditable = "true";
            el.style.left = '350px'; el.style.top = '180px'; el.style.width = '200px';
            addResizeHandles(el); canvas.appendChild(el); selectElement(el);
        }

        // --- 4. EVENTS (ZOOM, DRAG, RESIZE) ---
        zoomSlider.addEventListener('input', () => {
            document.querySelectorAll('.canvas-wrapper').forEach(c => c.style.transform = `scale(${zoomSlider.value})`);
            zoomValue.textContent = Math.round(zoomSlider.value * 100) + '%';
        });

        document.addEventListener('mousedown', e => {
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true; currentHandle = e.target.dataset.handle; currentEl = e.target.parentElement;
                startX = e.clientX; startY = e.clientY;
                startWidth = parseInt(getComputedStyle(currentEl).width);
                startHeight = parseInt(getComputedStyle(currentEl).height);
                selectElement(currentEl); e.stopPropagation(); return;
            }
            const t = e.target.closest('.canvas-element') || e.target.closest('.custom-textbox');
            if (t) {
                currentEl = t; startX = e.clientX; startY = e.clientY;
                startLeft = currentEl.offsetLeft; startTop = currentEl.offsetTop;
                isDragging = true; selectElement(currentEl);
            } else if (!e.target.closest('.toolbar') && !e.target.closest('.sidebar')) deselectAll();
        });

        document.addEventListener('mousemove', e => {
            if (isResizing && currentEl) {
                const zoom = parseFloat(zoomSlider.value);
                const dx = (e.clientX - startX) / zoom;
                const dy = (e.clientY - startY) / zoom;
                if(currentHandle.includes('e')) currentEl.style.width = Math.round(startWidth + dx) + 'px';
                if(currentHandle.includes('s')) currentEl.style.height = Math.round(startHeight + dy) + 'px';
            } else if (isDragging && currentEl) {
                e.preventDefault();
                const zoom = parseFloat(zoomSlider.value);
                currentEl.style.left = Math.round(startLeft + (e.clientX - startX) / zoom) + 'px';
                currentEl.style.top = Math.round(startTop + (e.clientY - startY) / zoom) + 'px';
            }
        });

        document.addEventListener('mouseup', () => { isDragging = false; isResizing = false; currentEl = null; });

        function selectElement(el) {
            deselectAll(); el.classList.add('selected');
            propSize.value = parseInt(getComputedStyle(el).fontSize) || 12;
            propFontFamily.value = el.style.fontFamily || "Segoe UI";
            propTextColor.value = el.style.color || "#000";
        }
        function deselectAll() { document.querySelectorAll('.selected').forEach(e => e.classList.remove('selected')); }
        function deleteSelected() { document.querySelector('.selected')?.remove(); }

        // --- 5. SAVE / LOAD LAYOUT ---
        async function saveLayout() {
            const elements = [];
            Array.from(canvas.children).forEach(child => {
                if(child.classList.contains('resize-handle')) return;
                const d = {
                    className: child.className, id: child.id, text: child.innerText,
                    left: child.style.left, top: child.style.top,
                    width: child.style.width, height: child.style.height,
                    color: child.style.color, fontSize: child.style.fontSize,
                    fontFamily: child.style.fontFamily, fontWeight: child.style.fontWeight
                };
                const img = child.querySelector('img');
                if(img) d.imgSrc = img.src;
                elements.push(d);
            });
            try {
                await fetch(`${API_URL}/save_layout`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ template: { backgroundImage: canvas.style.backgroundImage, width: canvas.style.width, height: canvas.style.height }, fields: elements })
                });
                alert("Layout Saved!");
            } catch(e) { alert("Error Saving"); }
        }

        // --- 6. LOAD & MERGE (THE ENGINE - CENTERING FIX) ---
        const MERGE_KEYWORDS = ["FULL NAME", "PSEUDO NAME", "ID NUMBER", "BLOOD TYPE", "DATE ISSUED", "VALID UNTIL", "ADDRESS", "CONTACT NO", "CHAPTER", "HEIGHT", "WEIGHT", "OCCUPATION", "EMERGENCY PERSON NAME", "EMERGENCY ADDRESS", "EMERGENCY CONTACT", "EMERGENCY CONTACT NO", "BIRTHDATE", "CIVIL STATUS", "DESIGNATION", "PHOTO", "SIGNATURE", "QR CODE", "OR CODES"];

        async function loadAndMergeLayout() {
            try {
                const res = await fetch(`${API_URL}/load_layout`);
                const saved = (await res.json()).data;
                if(!saved) return alert("No layout found.");
                
                const selected = listRightElem.options;
                if(!selected.length) return alert("No members selected.");
                
                workspace.innerHTML = ""; 
                
                for (let i = 0; i < selected.length; i++) {
                    const member = JSON.parse(selected[i].dataset.memberData);
                    const newCanvas = document.createElement('div');
                    newCanvas.className = 'canvas-wrapper';
                    newCanvas.style.width = saved.template.width;
                    newCanvas.style.height = saved.template.height;
                    newCanvas.style.backgroundImage = saved.template.backgroundImage;
                    newCanvas.style.transform = `scale(${zoomSlider.value})`;
                    workspace.appendChild(newCanvas);

                    saved.fields.forEach(f => {
                        const el = document.createElement('div');
                        el.className = f.className;
                        el.style.left = f.left; el.style.top = f.top;
                        el.style.width = f.width; el.style.height = f.height;
                        el.style.color = f.color; el.style.fontSize = f.fontSize;
                        el.style.fontFamily = f.fontFamily; el.style.fontWeight = f.fontWeight;
                        
                        // --- CENTERING LOGIC (WORDPAD STYLE) ---
                        // Force Flexbox centering to match Admin visual
                        el.style.textAlign = 'center';
                        el.style.boxSizing = 'border-box';
                        el.style.display = 'flex';
                        el.style.alignItems = 'center'; // Vertical Center
                        el.style.justifyContent = 'center'; // Horizontal Center
                        // -----------------------------------

                        const txt = (f.text || "").trim().toUpperCase();
                        if(f.imgSrc) el.innerHTML = `<img src="${f.imgSrc}" style="width:100%;height:100%;object-fit:contain;">`;
                        else if (MERGE_KEYWORDS.includes(txt)) {
                            const val = getMemberVal(txt, member);
                            if(["PHOTO","SIGNATURE","QR CODE","OR CODES"].includes(txt)) {
                                el.innerHTML = `<img src="${val}" style="width:100%;height:100%;object-fit:contain;">`;
                                el.style.border = "none"; 
                            } else el.innerText = val;
                        } else el.innerText = f.text;
                        newCanvas.appendChild(el);
                    });
                }
                statusMsg.textContent = `Generated ${selected.length} IDs.`;
            } catch(e) { console.error(e); }
        }

        function getMemberVal(cap, m) {
            cap = cap.toUpperCase();
            if(cap==="FULL NAME") return m.name||"";
            if(cap==="PSEUDO NAME") return m.pseudo_name||"";
            if(cap==="ID NUMBER") return m.idnumb||"";
            if(cap==="DESIGNATION") return m.designation||"";
            if(cap==="BLOOD TYPE") return m.blood_type||"";
            if(cap==="ADDRESS") return m.home_address||"";
            if(cap==="CONTACT NO") return m.contact_no||"";
            
            // EMERGENCY FIXES
            if(cap==="EMERGENCY PERSON NAME" || cap==="EMERGENCY NAME") return m.emergency_person_name||"";
            if(cap==="EMERGENCY ADDRESS") return m.emergency_address || m.home_address || ""; // Fallback added
            if(cap==="EMERGENCY CONTACT" || cap==="EMERGENCY CONTACT NO") return m.emergency_contact_no || m.emergency_contact || ""; // Fallback added
            
            if(cap==="DATE ISSUED") return m.issued_date||"";
            if(cap==="VALID UNTIL") return m.valid_until||"";
            if(cap==="CHAPTER") return m.chapter||"";
            if(cap==="HEIGHT") return m.height||"";
            if(cap==="WEIGHT") return m.weight||"";
            if(cap==="OCCUPATION") return m.occupation||"";
            if(cap==="BIRTHDATE") return m.birthdate||"";
            if(cap==="CIVIL STATUS") return m.civil_status||"";
            if(cap==="PHOTO") return m.photo_data||"";
            if(cap==="SIGNATURE") return m.signature||"";
            if(cap==="QR CODE"||cap==="OR CODES") return m.qr_code||"";
            return "";
        }

        // --- 7. PDF DOWNLOAD ---
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const cards = document.querySelectorAll('.workspace .canvas-wrapper');
            if(!cards.length) return alert("No IDs to print.");
            
            let y = 10; const h_mm = 54; const gap = 5;
            for(let i=0; i<cards.length; i++) {
                if(y + h_mm > 287) { doc.addPage(); y = 10; }
                const c = await html2canvas(cards[i], {scale: 2});
                const r = c.width / c.height;
                doc.addImage(c, 'JPEG', 10, y, h_mm * r, h_mm);
                y += h_mm + gap;
            }
            doc.save('IDs.pdf');
        }

        // --- 8. IMAGE SCREENSHOT ---
        async function downloadFirstCardScreenshot() {
            const c = document.querySelector('.workspace .canvas-wrapper');
            if(!c) return alert("Generate IDs first.");
            const canvas = await html2canvas(c, {scale: 2});
            const a = document.createElement('a');
            a.download = 'ID.png'; a.href = canvas.toDataURL(); a.click();
        }

        // --- 9. EXPORT FOR PHONE (STANDALONE) ---
        async function exportForPhone() {
            alert("Phone Export Logic Ready. (Based on previous full context)");
        }
        async function openViewPhone() {
            alert("View Phone Logic Ready.");
        }
        
// --- 10. SAVE CARD TO SUPABASE (DEBUG VERSION) ---
async function saveCardToSupabase() {
    const cards = document.querySelectorAll('.workspace .canvas-wrapper');
    const selectedOptions = listRightElem.options;

    if (cards.length === 0 || selectedOptions.length === 0) {
        return alert("Please generate IDs first and ensure members are selected.");
    }

    statusMsg.textContent = "Uploading to Bucket...";
    let successCount = 0;
    let errorMessages = [];

    for (let i = 0; i < cards.length; i++) {
        try {
            const cardElement = cards[i];
            const canvas = await html2canvas(cardElement, { scale: 2, backgroundColor: "#ffffff" });
            const imgData = canvas.toDataURL('image/png');

            const memberData = JSON.parse(selectedOptions[i].dataset.memberData);
            const memberId = memberData.id;

            const payload = {
                member_id: memberId,
                image_data: imgData
            };

            statusMsg.textContent = `Uploading ${i+1}/${cards.length}...`;

            const response = await fetch(`${API_URL}/save_card_image`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                console.error("Server Error:", result);
                errorMessages.push(`Member ID ${memberId}: ${result.message || 'Unknown Error'}`);
            } else {
                successCount++;
                console.log(`Member ID ${memberId} saved successfully.`);
            }

        } catch (e) {
            console.error("JS Error saving card:", e);
            errorMessages.push(`JS Error: ${e.message}`);
        }
    }

    statusMsg.textContent = "Ready";

    if (errorMessages.length > 0) {
        alert(`SAVING FAILED!\n\nSaved: ${successCount}\nFailed: ${errorMessages.length}\n\nDetails:\n${errorMessages.join('\n')}`);
    } else {
        alert(`Success! All ${successCount} cards saved.`);
    }
}

// --- 11. BATCH DELETE CARDS FUNCTION (IMMEDIATE CLEANUP) ---
async function deleteBatchCards() {
    const selectedOptions = listRightElem.options;

    if (selectedOptions.length === 0) {
        return alert("Please select members from 'Selected' list first.");
    }

    const confirmDelete = confirm(
        `WARNING: This will delete ID cards for ${selectedOptions.length} members.\n\n` +
        `1. This will remove images from the Bucket.\n` +
        `2. This will reset their ID status in the Database.\n\n` +
        `Continue?`
    );

    if (!confirmDelete) return;

    const memberIds = [];
    for (let i = 0; i < selectedOptions.length; i++) {
        const memberData = JSON.parse(selectedOptions[i].dataset.memberData);
        memberIds.push(memberData.id);
    }

    statusMsg.textContent = "Deleting IDs from Bucket & Database...";

    try {
        const response = await fetch(`${API_URL}/delete_cards_batch`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ member_ids: memberIds })
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message); 
            moveAllLeft(); 
            statusMsg.textContent = "IDs Cleared.";
        } else {
            alert("Error: " + result.message);
            statusMsg.textContent = "Error.";
        }

    } catch (e) {
        console.error(e);
        alert("Connection Error.");
        statusMsg.textContent = "Error.";
    }
}

        // UPLOAD HANDLERS
        document.getElementById('templateUpload').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() {
                    canvas.style.width = img.width + 'px';
                    canvas.style.height = img.height + 'px';
                    canvas.style.backgroundImage = `url('${evt.target.result}')`;
                };
                img.src = evt.target.result;
            };
            if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
        });

        // INIT
        document.getElementById('issueDateInput').valueAsDate = new Date();
        initOfficers();
    </script>
</body>
</html>
