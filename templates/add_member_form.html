{% extends "base.html" %}
{% block title %}Add New Member{% endblock %}

{% block content %}
<!-- 
   STYLE BLOCK FOR MOBILE RESPONSIVENESS 
-->
<style>
    /* Center form and give it a max width on large screens */
    .form-container {
        width: 100%;
        max-width: 800px; /* Dito nagkaka-center sa desktop */
        margin: 0 auto;
        box-sizing: border-box;
    }

    /* --- MOBILE ADJUSTMENTS (Celphone View) --- */
    @media (max-width: 700px) {
        
        /* 1. AYUSIN ANG FORM FIELDS (Inputs) */
        /* Sa celpon, ibabaw na yung fields */
        .form-container > div[style*="display:flex"] {
            flex-direction: column !important;
            gap: 10px !important;
        }
        
        /*pero sa loob ng sections, compact lang */
        .form-container > div > div[style*="display:flex"] {
             flex-wrap: wrap !important;
             gap: 8px !important;
        }

        .form-container input, 
        .form-container select, 
        .form-container textarea {
            font-size: 16px !important; /* Prevent iOS zoom */
            width: 100% !important;
        }
        
        /* 2. AYUSIN ANG MAGIC LISTBOX (DITO YUNG MALAKING LISTBOX) */
        #magic_content_area {
            /* I-scroll agad nang taas kapag nabuksan */
            position: relative; 
            z-index: 999; /* Nasa taas niya lahat */
        }

        #members_listbox {
            height: 200px !important; /* Higit na taas para makita mo agad */
            font-size: 16px !important; /* Mas malaking text para basa */
            padding: 10px !important;
        }
        
        /* 3. AYUSIN ANG CAMERA BUTTONS (Fixed Position) */
        /* Sa laptop absolute, sa mobile static at maliit */
        #switch_camera_btn, #cancel_camera_btn, #upload_photo_btn {
            position: static !important;
            display: inline-flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 48px !important; 
            height: 48px !important;
            padding: 0 !important;
            margin: 5px 2px !important;
            border-radius: 50% !important;
            flex-shrink: 0 !important; /* Prevent shrinking */
        }

        /* Controls Wrapper */
        .camera-controls-wrapper {
            display: flex !important;
            justify-content: center !important;
            gap: 10px !important;
            margin-top: 15px !important;
            flex-wrap: wrap !important;
        }

        /* 4. AYUSIN ANG MAGIC ACTION BUTTONS (Add, Edit, Save, Delete) */
        /* Ito yung tumatakbong specific sa Magic Area lang */
        #magic_content_area .magic-action-btn {
            flex: 0 1 auto !important; /* Auto width based on content */
            padding: 8px 12px !important; /* Maliit na padding */
            font-size: 13px !important; /* Maliit na text */
            min-width: 60px !important; /* Hindi masyadong liit */
            margin: 2px !important;
            display: inline-block !important;
            width: auto !important; /* Hindi full width */
        }

        /* 5. AYUSIN ANG NAV BUTTONS (Arrows) - SIDE BY SIDE LIKE LAPTOP */
        /* Hindi na sila full width, side by side sila tulad sa laptop */
        #magic_content_area button[title="Home"], 
        #magic_content_area button[title="Previous"],
        #magic_content_area button[title="Next"], 
        #magic_content_area button[title="End"],
        #magic_content_area button[title="Populate"] {
            width: 38px !important; 
            height: 38px !important;
            padding: 0 !important;
            flex-shrink: 0 !important;
            display: inline-flex !important; /* Make them inline */
        }
    }
</style>

<h1 style="text-align:center; color:#333;">Add New Member</h1>
<form method="POST" class="form-container" style="display:flex; flex-direction:column; gap:15px; padding:20px; border:1px solid #ddd; border-radius:10px; background:#fff;">

    <!-- IMPORTANT: HIDDEN FIELDS FOR LOGIC -->
    <!-- 1. Action: Kung 'add' o 'update' -->
    <input type="hidden" name="form_action" id="form_action_field" value="add">
    <!-- 2. Member ID: Kung ano ang ID ng ina-update -->
    <input type="hidden" name="member_id" id="member_id_field" value="">

    <!-- ID TOOLS SECTION -->
    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
        <label for="id_no_field" style="font-weight: bold;">ID No.:</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <input type="text" id="id_no_field" name="id_no" placeholder="e.g., ID-2024-0001" readonly style="padding:10px; font-size:16px; flex-grow: 1; background-color: #e9e9e9;">
            <button id="refresh_id_btn" type="button" style="padding:10px; border:none; border-radius:50%; background-color:#007bff; color:white; cursor:pointer; font-size:16px;">üîÑ</button>
        </div>
        <div id="id_details_container" style="display:none; margin-top: 15px;">
            <div style="display:flex; gap:15px;">
                <div style="flex:1;">
                    <label for="word_field">Word Format:</label>
                    <input type="text" id="word_field" name="word_field" placeholder="e.g., MEMBER" style="padding:10px; font-size:16px; width:100%;">
                </div>
                <div style="flex:1;">
                    <label for="number_field">Number Format:</label>
                    <input type="text" id="number_field" name="number_field" placeholder="e.g., 00000" style="padding:10px; font-size:16px; width:100%;">
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                <button id="cancel_id_btn" type="button" style="padding:8px 15px; border:1px solid #ccc; border-radius:5px; background:#fff; color:#333; cursor:pointer;">Cancel</button>
                <button id="save_id_btn" type="button" style="padding:8px 15px; border:none; border-radius:5px; background:#28a745; color:white; cursor:pointer;">Save</button>
            </div>
        </div>
    </div>

    <!-- PERSONAL DETAILS SECTION -->
    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
        <h3 style="margin-top:0; color:#555;">Personal Details</h3>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="name_field">Full Name:</label>
                <input type="text" id="name_field" name="name" placeholder="Juan Dela Cruz" required style="padding:10px; font-size:16px; width:100%;">
            </div>
            <div style="flex:1;">
                <label for="gender_field">Gender:</label>
                <select id="gender_field" name="gender" style="padding:10px; font-size:16px; width:100%;">
                    <option value="">-- Select Gender --</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>
        
        <!-- ADDED: PSEUDO NAME -->
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="pseudo_name_field">Pseudo Name:</label>
                <input type="text" id="pseudo_name_field" name="pseudo_name" placeholder="e.g., Juaning" style="padding:10px; font-size:16px; width:100%;">
            </div>
        </div>

        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="birthdate_field">Birthdate:</label>
                <input type="date" id="birthdate_field" name="birthdate" required style="padding:10px; font-size:16px; width:100%;">
            </div>
            <div style="flex:1;">
                <label for="civil_status_field">Civil Status:</label>
                <select id="civil_status_field" name="civil_status" style="padding:10px; font-size:16px; width:100%;">
                    <option value="">-- Select Status --</option>
                    <option value="Single">Single</option>
                    <option value="Married">Married</option>
                    <option value="Widowed">Widowed</option>
                    <option value="Widower">Widower</option>
                    <option value="Separated">Separated</option>
                    <option value="Divorced">Divorced</option>
                </select>
            </div>
        </div>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="country_field">Country:</label>
                <input type="text" id="country_field" name="country" placeholder="e.g., Philippines" list="country_list" style="padding:10px; font-size:16px; width:100%;">
                <datalist id="country_list">
                    <option value="Afghanistan"><option value="Albania"><option value="Algeria"><option value="Andorra"><option value="Angola"><option value="Argentina"><option value="Armenia"><option value="Australia"><option value="Austria"><option value="Azerbaijan"><option value="Bahamas"><option value="Bahrain"><option value="Bangladesh"><option value="Barbados"><option value="Belarus"><option value="Belgium"><option value="Belize"><option value="Benin"><option value="Bhutan"><option value="Bolivia"><option value="Bosnia and Herzegovina"><option value="Botswana"><option value="Brazil"><option value="Brunei"><option value="Bulgaria"><option value="Burkina Faso"><option value="Burundi"><option value="Cabo Verde"><option value="Cambodia"><option value="Cameroon"><option value="Canada"><option value="Central African Republic"><option value="Chad"><option value="Chile"><option value="China"><option value="Colombia"><option value="Comoros"><option value="Congo (Congo-Brazzaville)"><option value="Costa Rica"><option value="Croatia"><option value="Cuba"><option value="Cyprus"><option value="Czechia (Czech Republic)"><option value="Denmark"><option value="Djibouti"><option value="Dominica"><option value="Dominican Republic"><option value="Ecuador"><option value="Egypt"><option value="El Salvador"><option value="Equatorial Guinea"><option value="Eritrea"><option value="Estonia"><option value="Eswatini (fmr. Swaziland)"><option value="Ethiopia"><option value="Fiji"><option value="Finland"><option value="France"><option value="Gabon"><option value="Gambia"><option value="Georgia"><option value="Germany"><option value="Ghana"><option value="Greece"><option value="Grenada"><option value="Guatemala"><option value="Guinea"><option value="Guinea-Bissau"><option value="Guyana"><option value="Haiti"><option value="Holy See"><option value="Honduras"><option value="Hungary"><option value="Iceland"><option value="India"><option value="Indonesia"><option value="Iran"><option value="Iraq"><option value="Ireland"><option value="Israel"><option value="Italy"><option value="Jamaica"><option value="Japan"><option value="Jordan"><option value="Kazakhstan"><option value="Kenya"><option value="Kiribati"><option value="Kuwait"><option value="Kyrgyzstan"><option value="Laos"><option value="Latvia"><option value="Lebanon"><option value="Lesotho"><option value="Liberia"><option value="Libya"><option value="Liechtenstein"><option value="Lithuania"><option value="Luxembourg"><option value="Madagascar"><option value="Malawi"><option value="Malaysia"><option value="Maldives"><option value="Mali"><option value="Malta"><option value="Marshall Islands"><option value="Mauritania"><option value="Mauritius"><option value="Mexico"><option value="Micronesia"><option value="Moldova"><option value="Monaco"><option value="Mongolia"><option value="Montenegro"><option value="Morocco"><option value="Mozambique"><option value="Myanmar (formerly Burma)"><option value="Namibia"><option value="Nauru"><option value="Nepal"><option value="Netherlands"><option value="New Zealand"><option value="Nicaragua"><option value="Niger"><option value="Nigeria"><option value="North Korea"><option value="North Macedonia"><option value="Norway"><option value="Oman"><option value="Pakistan"><option value="Palau"><option value="Palestine State"><option value="Panama"><option value="Papua New Guinea"><option value="Paraguay"><option value="Peru"><option value="Philippines"><option value="Poland"><option value="Portugal"><option value="Qatar"><option value="Romania"><option value="Russia"><option value="Rwanda"><option value="Saint Kitts and Nevis"><option value="Saint Lucia"><option value="Saint Vincent and the Grenadines"><option value="Samoa"><option value="San Marino"><option value="Sao Tome and Principe"><option value="Saudi Arabia"><option value="Senegal"><option value="Serbia"><option value="Seychelles"><option value="Sierra Leone"><option value="Singapore"><option value="Slovakia"><option value="Slovenia"><option value="Solomon Islands"><option value="Somalia"><option value="South Africa"><option value="South Korea"><option value="South Sudan"><option value="Spain"><option value="Sri Lanka"><option value="Sudan"><option value="Suriname"><option value="Sweden"><option value="Switzerland"><option value="Syria"><option value="Tajikistan"><option value="Tanzania"><option value="Thailand"><option value="Timor-Leste"><option value="Togo"><option value="Tonga"><option value="Trinidad and Tobago"><option value="Tunisia"><option value="Turkey"><option value="Turkmenistan"><option value="Tuvalu"><option value="Uganda"><option value="Ukraine"><option value="United Arab Emirates"><option value="United Kingdom"><option value="United States of America"><option value="Uruguay"><option value="Uzbekistan"><option value="Vanuatu"><option value="Venezuela"><option value="Vietnam"><option value="Yemen"><option value="Zambia"><option value="Zimbabwe">
                </datalist>
            </div>
            <div style="flex:1;">
                <label for="blood_type_field">Blood Type:</label>
                <select id="blood_type_field" name="blood_type" required style="padding:10px; font-size:16px; width:100%;">
                    <option value="">-- Select Blood Type --</option>
                    <option value="A+">A+</option><option value="A-">A-</option>
                    <option value="B+">B+</option><option value="B-">B-</option>
                    <option value="AB+">AB+</option><option value="AB-">AB-</option>
                    <option value="O+">O+</option><option value="O-">O-</option>
                </select>
            </div>
        </div>
    </div>

    <!-- MEMBERSHIP & CONTACT SECTION -->
    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
        <h3 style="margin-top:0; color:#555;">Membership & Contact</h3>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="designation_field">Designation:</label>
                <input type="text" id="designation_field" name="designation" placeholder="Member" required style="padding:10px; font-size:16px; width:100%;">
            </div>
            <div style="flex:1;">
                <label for="chapter_field">Chapter:</label>
                <input type="text" id="chapter_field" name="chapter" placeholder="Occidental Mindoro" required style="padding:10px; font-size:16px; width:100%;">
            </div>
        </div>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="date_of_membership_field">Date of Membership:</label>
                <input type="date" id="date_of_membership_field" name="date_of_membership" required style="padding:10px; font-size:16px; width:100%;">
            </div>
            <div style="flex:1;">
                <label for="membership_type_field">Membership Type:</label>
                <input type="text" id="membership_type_field" name="membership_type" placeholder="Regular" style="padding:10px; font-size:16px; width:100%;">
            </div>
        </div>

        <!-- ADDED FIELDS: ISSUED DATE & VALID UNTIL -->
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="issued_date_field">Issued Date:</label>
                <input type="date" id="issued_date_field" name="issued_date" style="padding:10px; font-size:16px; width:100%;">
            </div>
            <div style="flex:1;">
                <label for="valid_until_field">Valid Until:</label>
                <input type="date" id="valid_until_field" name="valid_until" style="padding:10px; font-size:16px; width:100%;">
            </div>
        </div>

        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="contact_no_field">Contact No.:</label>
                <input type="tel" id="contact_no_field" name="contact_no" placeholder="+639123456789" required style="padding:10px; font-size:16px; width:100%;">
            </div>
            <!-- EMAIL ADDRESS DITO LANG NAKA FULL WIDTH SA MOBILE -->
        </div>
        <div style="margin-top:5px;">
            <label for="email_field">Email Address:</label>
            <input type="email" id="email_field" name="email" placeholder="juan.delacruz@example.com" style="padding:10px; font-size:16px; width:100%;">
        </div>

        <label for="home_address_field" style="margin-top:10px; display:block;">Home Address:</label>
        <textarea id="home_address_field" name="home_address" rows="3" placeholder="123 Main St, Barangay, City" required style="padding:10px; font-size:16px;"></textarea>
    </div>

    <!-- OTHER INFORMATION SECTION -->
    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
        <h3 style="margin-top:0; color:#555;">Other Information</h3>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="height_field">Height (cm):</label>
                <input type="number" id="height_field" name="height" placeholder="170" required style="padding:10px; font-size:16px; width:100%;">
            </div>
            <div style="flex:1;">
                <label for="weight_field">Weight (kg):</label>
                <input type="number" id="weight_field" name="weight" placeholder="70" required style="padding:10px; font-size:16px; width:100%;">
            </div>
        </div>
        
        <!-- OCCUPATION DITO LANG NAKA FULL WIDTH SA MOBILE -->
        <div style="margin-top:10px;">
            <label for="occupation_field">Occupation:</label>
            <input type="text" id="occupation_field" name="occupation" placeholder="e.g., Engineer" style="padding:10px; font-size:16px; width:100%;">
        </div>

        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label for="govt_id_presented_field">Gov't ID Presented:</label>
                <select id="govt_id_presented_field" name="govt_id_presented" style="padding:10px; font-size:16px; width:100%;">
                    <option value="">-- Select ID --</option>
                    <option value="Passport">Passport</option>
                    <option value="Driver's License">Driver's License</option>
                    <option value="National ID">National ID</option>
                    <option value="SSS ID">SSS ID</option>
                </select>
            </div>
        </div>
        <label for="govt_id_no_field">Gov't ID Number:</label>
        <input type="text" id="govt_id_no_field" name="govt_id_no" placeholder="e.g., XXXXXXXXX" style="padding:10px; font-size:16px;">
        
        <!-- INSERTED: QR CODE & SIGNATURE SECTION -->
        <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
            <div style="display:flex; gap:15px;">
                <!-- 1. QR Code Placeholder -->
                <div style="flex:1;">
                    <label for="qr_code_field">QR Code:</label>
                    <input type="text" id="qr_code_field" name="qr_code" placeholder="Generated QR Code..." readonly style="padding:10px; font-size:16px; width:100%; background-color: #e9e9e9;">
                </div>
                <!-- 2. Signature Textbox & 3. Small Button (UPDATED WITH ID) -->
                <div style="flex:1;">
                    <label for="signature_field">Signature:</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="text" id="signature_field" name="signature" placeholder="Type or Sign Here" style="padding:10px; font-size:16px; flex-grow: 1;">
                        <button type="button" id="open_sig_btn" style="padding:8px 12px; border:none; border-radius:4px; background:#007bff; color:white; cursor:pointer; font-size:12px;">‚úçÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END INSERTION -->
    </div>

    <!-- EMERGENCY CONTACT SECTION -->
    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
        <h3 style="margin-top:0; color:#555;">Emergency Contact</h3>
        <label for="emergency_person_name_field">Emergency Person Name:</label>
        <input type="text" id="emergency_person_name_field" name="emergency_person_name" placeholder="Maria Dela Cruz" style="padding:10px; font-size:16px;">
        <label for="emergency_contact_no_field">Emergency Contact No.:</label>
        <input type="tel" id="emergency_contact_no_field" name="emergency_contact_no" placeholder="+639987654321" style="padding:10px; font-size:16px;">
        <button id="search_emergency_btn" type="button" onclick="openSearchModal()" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:8px; cursor:pointer; align-self: flex-start; margin-top:10px;">Search</button>
    </div>

    <!-- PHOTO / CAMERA SECTION -->
    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
        <h3 style="margin-top:0; color:#555;">Member Photo</h3>
        <div style="position: relative; text-align: center;">
            <div class="camera-preview-container" style="position:relative; display:inline-block; width:280px; height:280px; border:2px solid #ccc; border-radius:10px; overflow:hidden;">
                <video id="video" autoplay playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; display:none;"></video>
                <img id="photo_preview" src="https://placehold.co/280x280/cccccc/333333?text=Photo+Preview" alt="Captured Photo Preview" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;">
            </div>
            <!-- NOTE: Absolute positions for Laptop. Overridden by CSS for Mobile. -->
            <button id="switch_camera_btn" type="button" style="position: absolute; left: calc(50% + 165px); bottom: 150px; padding:10px 14px; border:none; border-radius:50%; background-color:#FF9800; color:white; cursor:pointer; font-size:18px; display:none;">üîÑ</button>
            <button id="cancel_camera_btn" type="button" style="position: absolute; left: calc(50% + 165px); bottom: 100px; padding:10px 14px; border:none; border-radius:50%; background-color:#f44336; color:white; cursor:pointer; font-size:18px; display:none;">‚úñ</button>
            <button id="upload_photo_btn" type="button" style="position: absolute; left: calc(50% + 165px); bottom: 50px; padding:10px 14px; border:none; border-radius:50%; background-color:#2196F3; color:white; cursor:pointer; font-size:18px;">üì∑</button>
            <div id="main_camera_controls" class="camera-controls-wrapper" style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
                <button id="activate_camera_btn" type="button" style="padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer;">Activate Camera</button>
                <button id="take_picture_btn" type="button" style="display:none; padding:10px 20px; background:#008CBA; color:white; border:none; cursor:pointer;">Take Picture</button>
                <button id="clear_photo_btn" type="button" style="display:none; padding:10px 20px; background:#ff9800; color:white; border:none; cursor:pointer;">Clear Photo</button>
            </div>
        </div>
    </div>

    <!-- Hidden Elements -->
    <input type="file" id="file_input" accept="image/*" style="display:none;">
    <canvas id="canvas" width="280" height="280" style="display:none;"></canvas>
    <input type="hidden" name="photo_data" id="photo_data">
    <input type="hidden" name="photo_url" id="photo_url_field">

    <!-- Magic Button -->
    <button type="button" id="magic_btn" style="margin:10px auto; display:block; padding:10px 20px; background:#6a1b9a; color:white; border:none; border-radius:8px; cursor:pointer;">Button Show</button>
    
    <!-- Magic Content Area -->
    <div id="magic_content_area" style="display:none; border: 1px solid #6a1b9a; padding: 20px; border-radius: 8px; background-color: #faf5ff; margin-bottom:10px;">
        <select id="members_listbox" size="8" style="width:100%; padding:8px; font-size:14px; border:2px solid #6a1b9a; border-radius:5px; background:#fff; margin-bottom:15px;">
            <option disabled>Type in textbox to search...</option>
        </select>
        <div style="display:flex; justify-content:center; gap:8px; margin-bottom:15px;">
            <button type="button" id="nav_home_btn" title="Home" style="padding:8px 12px; border:2px solid #6a1b9a; border-radius:50%; background:#f3e5f5; color:#6a1b9a; cursor:pointer; font-size:16px; transition:all 0.3s;">üè†</button>
            <button type="button" id="nav_prev_btn" title="Previous" style="padding:8px 12px; border:2px solid #6a1b9a; border-radius:50%; background:#f3e5f5; color:#6a1b9a; cursor:pointer; font-size:16px; transition:all 0.3s;">‚¨ÖÔ∏è</button>
            <button type="button" id="nav_next_btn" title="Next" style="padding:8px 12px; border:2px solid #6a1b9a; border-radius:50%; background:#f3e5f5; color:#6a1b9a; cursor:pointer; font-size:16px; transition:all 0.3s;">‚û°Ô∏è</button>
            <button type="button" id="nav_end_btn" title="End" style="padding:8px 12px; border:2px solid #6a1b9a; border-radius:50%; background:#f3e5f5; color:#6a1b9a; cursor:pointer; font-size:16px; transition:all 0.3s;">üîö</button>
            <button type="button" id="nav_pop_btn" title="Populate" style="padding:8px 12px; border:2px solid #6a1b9a; border-radius:50%; background:#f3e5f5; color:#6a1b9a; cursor:pointer; font-size:16px; transition:all 0.3s;">P</button>
        </div>
        <input type="text" id="magic_textbox" placeholder="Type to search from Supabase..." style="width:100%; padding:10px; font-size:14px; border:2px solid #6a1b9a; border-radius:5px; margin-bottom:15px;">
        <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
            <button type="button" class="magic-action-btn" data-action="add" style="padding:10px 20px; border:2px solid #6a1b9a; border-radius:8px; background:#f3e5f5; color:#6a1b9a; cursor:pointer;">Add</button>
            <button type="button" class="magic-action-btn" data-action="edit" style="padding:10px 20px; border:2px solid #6a1b9a; border-radius:8px; background:#f3e5f5; color:#6a1b9a; cursor:pointer;">Edit</button>
            <button type="button" class="magic-action-btn" data-action="save" style="padding:10px 20px; border:2px solid #6a1b9a; border-radius:8px; background:#f3e5f5; color:#6a1b9a; cursor:pointer;">Save</button>
            <button type="button" class="magic-action-btn" data-action="delete" style="padding:10px 20px; border:2px solid #6a1b9a; border-radius:8px; background:#f3e5f5; color:#6a1b9a; cursor:pointer;">Delete</button>
            <button type="button" class="magic-action-btn" data-action="cancel" style="padding:10px 20px; border:2px solid #6a1b9a; border-radius:8px; background:#f3e5f5; color:#6a1b9a; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- Submit -->
    <button type="submit" id="submit_btn" style="margin-top:10px; padding:10px; background:#333; color:white; border:none; cursor:pointer;">Submit Registration</button>

</form>

<!-- ADDED: QR CODE LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<!-- ADDED: SIGNATURE PAD LIBRARY -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<!-- ADDED: SIGNATURE MODAL -->
<div id="signatureModal" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6);">
    <div style="background-color:white; margin:10% auto; padding:20px; border-radius:10px; width:90%; max-width:500px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
        <!-- Updated Caption to Tagalog -->
        <h3 style="margin-top:0; text-align:center;">Pakilagda Diyan</h3>
        
        <!-- Canvas Area -->
        <div style="border:2px solid #ccc; border-radius:5px; background-color:#fff; touch-action:none; position:relative; height:200px; width:100%;">
            <canvas id="signature-pad" style="width:100%; height:100%; display:block;"></canvas>
        </div>
        
        <!-- Updated Buttons: Clear, Delete, Save -->
        <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
            <button id="clear_sig_btn" type="button" style="padding:10px 20px; background:#fd7e14; color:white; border:none; border-radius:5px; cursor:pointer;">Clear</button>
            <button id="delete_sig_btn" type="button" style="padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer;">Delete</button>
            <button id="save_sig_btn" type="button" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;">Save</button>
        </div>
    </div>
</div>

<!-- SEARCH MODAL -->
<div id="searchModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
    <div style="background-color:white; margin:5% auto; padding:20px; border-radius:8px; width:80%; max-width:600px; box-shadow:0 4px 20px rgba(0,0,0,0.3); max-height:80vh; overflow-y:auto;">
        <span onclick="closeSearchModal()" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; line-height:20px;">&times;</span>
        <div id="searchFormContainer"></div>
    </div>
</div>

<script>
/* 
  FINAL VERSION: FIXED TOUCH & ADDED DELETE BUTTON
  UPDATED SIGNATURE PAD FOR SMOOTH FINGER/COTTON BUGS INPUT
  FIXED LISTBOX: CLICK & ARROW KEYS NOW UPDATE TEXTBOX & FORM
  FIXED SAVE LOGIC: QR GENERATION & ID REGENERATE TABLE UPDATE
  FIX: ID INCREMENT LOGIC (Padding Preservation)
  FIX: POPULATE CLICK BUG (Added click listener)
  FIX: PHOTO POPULATE ON MOBILE (Added stopCamera)
*/

(function () {
    // --- ELEMENTS ---
    const video = document.getElementById('video');
    const photoPreview = document.getElementById('photo_preview');
    const canvas = document.getElementById('canvas');
    const photoInput = document.getElementById('photo_data');
    const photoUrlField = document.getElementById('photo_url_field');
    const fileInput = document.getElementById('file_input');
    
    // Logic Fields
    const form = document.querySelector('form');
    const member_id_field = document.getElementById('member_id_field');
    const form_action_field = document.getElementById('form_action_field');
    const submitBtn = document.getElementById('submit_btn');

    // Buttons
    const activateCameraBtn = document.getElementById('activate_camera_btn');
    const takePictureBtn = document.getElementById('take_picture_btn');
    const clearPhotoBtn = document.getElementById('clear_photo_btn');
    const uploadPhotoBtn = document.getElementById('upload_photo_btn');
    const cancelCameraBtn = document.getElementById('cancel_camera_btn');
    const switchCameraBtn = document.getElementById('switch_camera_btn');
    
    // Magic Tools
    const magicBtn = document.getElementById('magic_btn');
    const magicContentArea = document.getElementById('magic_content_area');
    const membersListbox = document.getElementById('members_listbox');
    const magicTextbox = document.getElementById('magic_textbox');
    const navPopBtn = document.getElementById('nav_pop_btn');

    // ID Tools
    const refreshIdBtn = document.getElementById('refresh_id_btn');
    const idNoField = document.getElementById('id_no_field');
    const idDetailsContainer = document.getElementById('id_details_container');
    const cancelIdBtn = document.getElementById('cancel_id_btn');
    const saveIdBtn = document.getElementById('save_id_btn');
    const wordField = document.getElementById('word_field');
    const numberField = document.getElementById('number_field');

    // --- STATE ---
    let cameraStream = null;
    let currentDeviceId = null;
    let lastFacing = 'user';
    let isEditMode = false; 

    // ==============================
    //1. CAMERA LOGIC
    // ==============================
    function isSecureContext() {
        return location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    }

    async function enumerateCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            return devices.filter(d => d.kind === 'videoinput');
        } catch (e) { return []; }
    }

    async function findDeviceForFacing(facing) {
        const cams = await enumerateCameras();
        if (!cams.length) return null;
        const fl = facing === 'user' ? ['front', 'user'] : ['back', 'rear', 'environment'];
        for (const cam of cams) {
            if (fl.some(f => (cam.label || '').toLowerCase().includes(f))) return cam.deviceId;
        }
        if (cams.length === 2 && currentDeviceId) {
            const other = cams.find(c => c.deviceId !== currentDeviceId);
            if (other) return other.deviceId;
        }
        if (cams.length === 1) return cams[0].deviceId;
        return null;
    }

    function resetPhotoUI() {
        stopCamera();
        photoPreview.src = "https://placehold.co/280x280/cccccc/333333?text=Photo+Preview";
        photoInput.value = '';
        if(photoUrlField) photoUrlField.value = '';
        if (activateCameraBtn) activateCameraBtn.style.display = 'inline-block';
        if (takePictureBtn) takePictureBtn.style.display = 'none';
        if (clearPhotoBtn) clearPhotoBtn.style.display = 'none';
        if (cancelCameraBtn) cancelCameraBtn.style.display = 'none';
        if (switchCameraBtn) switchCameraBtn.style.display = 'none';
    }

    function showCameraUI() {
        if (activateCameraBtn) activateCameraBtn.style.display = 'none';
        if (takePictureBtn) takePictureBtn.style.display = 'inline-block';
        if (clearPhotoBtn) clearPhotoBtn.style.display = 'none';
        if (cancelCameraBtn) cancelCameraBtn.style.display = 'inline-block';
        if (switchCameraBtn) switchCameraBtn.style.display = 'inline-block';
    }

    function showPhotoTakenUI() {
        if (activateCameraBtn) activateCameraBtn.style.display = 'none';
        if (takePictureBtn) takePictureBtn.style.display = 'none';
        if (clearPhotoBtn) clearPhotoBtn.style.display = 'inline-block';
        if (cancelCameraBtn) cancelCameraBtn.style.display = 'none';
        if (switchCameraBtn) switchCameraBtn.style.display = 'none';
    }

    async function startCamera(preferredFacing = 'user') {
        lastFacing = preferredFacing;
        if (!isSecureContext()) {
            alert('Camera requires HTTPS or Localhost.');
        }
        stopCamera();
        try {
            const deviceId = await findDeviceForFacing(preferredFacing);
            let constraints;
            if (deviceId) {
                constraints = { video: { deviceId: { exact: deviceId } } };
                currentDeviceId = deviceId;
            } else {
                constraints = { video: { facingMode: { ideal: preferredFacing } } };
                currentDeviceId = null;
            }
            constraints.video.width = { ideal: 1280 };
            constraints.video.height = { ideal: 720 };
            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            if ('srcObject' in video) {
                video.srcObject = cameraStream;
            } else {
                video.src = window.URL.createObjectURL(cameraStream);
            }
            video.muted = true;
            video.playsInline = true;
            await video.play();
            video.style.display = 'block';
            photoPreview.style.display = 'none';
            showCameraUI();
        } catch (err) {
            console.error('Camera error', err);
            alert('Could not access camera.');
            resetPhotoUI();
        }
    }

    function stopCamera() {
        if (cameraStream) {
            try { cameraStream.getTracks().forEach(track => track.stop()); } catch (e) {}
            cameraStream = null;
        }
        video.pause();
        video.srcObject = null;
        video.style.display = 'none';
        photoPreview.style.display = 'block';
    }

    function takePicture() {
        const ctx = canvas.getContext('2d');
        const videoWidth = video.videoWidth || video.clientWidth;
        const videoHeight = video.videoHeight || video.clientHeight;
        const canvasSize = canvas.width;
        if (!videoWidth || !videoHeight) { alert('Camera not ready.'); return; }
        let sx, sy, sWidth, sHeight;
        if (videoWidth > videoHeight) {
            sWidth = videoHeight; sHeight = videoHeight; sx = (videoWidth - videoHeight) / 2; sy = 0;
        } else {
            sWidth = videoWidth; sHeight = videoWidth; sx = 0; sy = (videoHeight - videoWidth) / 2;
        }
        ctx.clearRect(0, 0, canvasSize, canvasSize);
        ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvasSize, canvasSize);
        const dataURL = canvas.toDataURL('image/jpeg', 0.9);
        photoPreview.src = dataURL;
        photoInput.value = dataURL;
        if(photoUrlField) photoUrlField.value = dataURL;
        stopCamera();
        showPhotoTakenUI();
    }

    if (activateCameraBtn) activateCameraBtn.addEventListener('click', () => startCamera('user'));
    if (takePictureBtn) takePictureBtn.addEventListener('click', takePicture);
    if (cancelCameraBtn) cancelCameraBtn.addEventListener('click', resetPhotoUI);
    if (clearPhotoBtn) clearPhotoBtn.addEventListener('click', resetPhotoUI);
    if (uploadPhotoBtn) uploadPhotoBtn.addEventListener('click', () => fileInput.click());
    if (switchCameraBtn) switchCameraBtn.addEventListener('click', () => startCamera(lastFacing === 'user' ? 'environment' : 'user'));
    
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    photoPreview.src = evt.target.result;
                    photoInput.value = evt.target.result;
                    if(photoUrlField) photoUrlField.value = evt.target.result;
                    showPhotoTakenUI();
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // ==============================
    //2. ID GENERATOR LOGIC
    // ==============================
    if (refreshIdBtn) {
        refreshIdBtn.addEventListener('click', async () => {
            if (idDetailsContainer.style.display === 'block') {
                idDetailsContainer.style.display = 'none';
                return;
            }
            idDetailsContainer.style.display = 'block';
            try {
                const response = await fetch('/get_current_id');
                const data = await response.json();
                if (data && data.idnumber) {
                    const parts = data.idnumber.split('-');
                    if (parts.length >= 2) {
                        wordField.value = parts[0];
                        numberField.value = parts.slice(1).join('-');
                    } else {
                        wordField.value = data.idnumber;
                        numberField.value = '';
                    }
                    idNoField.value = data.idnumber;
                    saveIdBtn.textContent = 'Update';
                    saveIdBtn.style.backgroundColor = '#ffc107';
                } else {
                    wordField.value = ''; numberField.value = '';
                    idNoField.value = '';
                    saveIdBtn.textContent = 'Save';
                    saveIdBtn.style.backgroundColor = '#28a745';
                }
            } catch (error) {
                console.error('Error', error);
                wordField.value = ''; numberField.value = '';
            }
        });
    }

    if (cancelIdBtn) cancelIdBtn.addEventListener('click', () => {
        idDetailsContainer.style.display = 'none';
        wordField.value = ''; numberField.value = '';
    });

    if (saveIdBtn) {
        saveIdBtn.addEventListener('click', async () => {
            const wordVal = wordField.value.trim();
            const numVal = numberField.value.trim();
            if (wordVal && numVal) {
                const combinedId = `${wordVal}-${numVal}`;
                idNoField.value = combinedId;
                try {
                    const response = await fetch('/save_id_to_db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_value: combinedId })
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        alert('Saved! ID: ' + combinedId);
                        idDetailsContainer.style.display = 'none';
                    } else {
                        alert('Failed: ' + result.message);
                    }
                } catch (error) { alert('Network error'); }
            } else { alert('Complete fields'); }
        });
    }

    // ==============================
    //3. MAGIC AUTOCOMPLETE - SEARCH & POPULATE (UPDATED FOR PHOTO)
    // ==============================
    async function fetchFromSupabase(queryText) {
        try {
            const response = await fetch(`/api/members/search?q=${encodeURIComponent(queryText)}`);
            const data = await response.json();
            populateListbox(data);
        } catch (error) {
            console.error('Error searching:', error);
        }
    }

    function populateListbox(members) {
        if (!membersListbox) return;
        membersListbox.innerHTML = ''; 
        
        if (members.length === 0) {
            const opt = document.createElement('option');
            opt.text = "No matches found.";
            opt.disabled = true;
            membersListbox.appendChild(opt);
            return;
        }

        members.forEach(member => {
            const option = document.createElement('option');
            const displayText = member.name + (member.chapter ? ` (${member.chapter})` : '');
            option.value = member.name; 
            option.textContent = displayText;
            option.dataset.fullData = JSON.stringify(member); 
            membersListbox.appendChild(option);
        });
        
        if (membersListbox.options.length > 0) {
            membersListbox.selectedIndex = 0;
        }
    }

    if (magicTextbox) {
        magicTextbox.addEventListener('input', function() {
            const queryText = this.value.trim();
            if (queryText.length === 0) {
                membersListbox.innerHTML = '<option disabled>Type in textbox to search...</option>';
                return;
            }
            fetchFromSupabase(queryText);
        });
    }

    if (membersListbox) {
        // --- FIX: FUNCTION TO POPULATE BOTH TEXTBOX & FORM ---
        const populateFieldsFromSelection = function() {
            const selected = this.options[this.selectedIndex];
            if (selected && !selected.disabled) {
                // 1. STOP CAMERA FIRST (Crucial fix for mobile photo display)
                stopCamera();

                // 2. UPDATE THE TEXTBOX (Solves your issue: "appear in textbox")
                if (magicTextbox) {
                    magicTextbox.value = selected.textContent; 
                }

                try {
                    const data = JSON.parse(selected.dataset.fullData);
                    
                    if(data.id) {
                        member_id_field.value = data.id;
                    } else {
                        console.warn("No ID found in search result!");
                    }

                    const manualMapping = { 
                        'idnumb': 'id_no_field',
                        'pseudo_name': 'pseudo_name_field' // Explicitly map pseudo name
                    };
                    
                    for (const key in data) {
                        let targetId;
                        if (manualMapping[key]) targetId = manualMapping[key];
                        else targetId = key + "_field";
                        
                        const element = document.getElementById(targetId);
                        if (element) {
                            if (element.tagName === 'SELECT') {
                                const valToMatch = String(data[key] || '').toLowerCase();
                                let matchFound = false;
                                
                                for (let i = 0; i < element.options.length; i++) {
                                    if (element.options[i].value.toLowerCase() === valToMatch) {
                                        element.selectedIndex = i;
                                        matchFound = true;
                                        break;
                                    }
                                }
                                
                                if (!matchFound) {
                                    element.selectedIndex = 0;
                                }
                            } else {
                                element.value = data[key] || '';
                            }
                        }
                    }

                    const existingPhoto = data.photo || data.photo_url || data.photo_data;
                    if(existingPhoto) {
                        const imgEl = document.getElementById('photo_preview');
                        if(imgEl) imgEl.src = existingPhoto;
                        if(photoInput) photoInput.value = existingPhoto;
                        if(photoUrlField) photoUrlField.value = existingPhoto;
                    } else {
                        resetPhotoUI();
                    }

                } catch (e) { console.error("Could not populate form", e); }
            }
        };

        // --- FIX: CLICK EVENT (Fixes "Click twice" bug) ---
        membersListbox.addEventListener('click', function(e) {
            // Force populate on click even if index doesn't change
            if (e.target.tagName === 'OPTION' && !e.target.disabled) {
                populateFieldsFromSelection.call(this);
            }
        });

        // --- FIX: ARROW KEY EVENT (Highlight Updates Textbox) ---
        membersListbox.addEventListener('keyup', function(e) {
            // Only act on Up/Down arrows
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                populateFieldsFromSelection.call(this);
            }
        });
        
        // --- FIX: CHANGE EVENT (Standard populate) ---
        membersListbox.addEventListener('change', function() {
             populateFieldsFromSelection.call(this);
        });
    }

    if (magicBtn && magicContentArea) {
        magicBtn.addEventListener('click', () => {
            const isHidden = magicContentArea.style.display === 'none' || magicContentArea.style.display === '';
            magicContentArea.style.display = isHidden ? 'block' : 'none';
            magicBtn.textContent = isHidden ? 'Button Hide' : 'Button Show';
            // I-focus sa textbox para mabilisang pag-type
            if(isHidden) magicTextbox.focus();
        });
    }

    if (navPopBtn) {
        navPopBtn.addEventListener('click', () => {
            magicTextbox.value = ''; 
            membersListbox.innerHTML = '<option disabled>Type in textbox to search...</option>'; 
            magicTextbox.focus(); 
        });
    }

    ['home', 'prev', 'next', 'end'].forEach(dir => {
        const btn = document.getElementById(`nav_${dir}_btn`);
        if(btn && membersListbox) {
            btn.addEventListener('click', () => {
                const len = membersListbox.options.length;
                if (len === 0) return; 
                let newIndex = membersListbox.selectedIndex;
                if (dir === 'home') newIndex = 0;
                if (dir === 'end') newIndex = len - 1;
                if (dir === 'prev' && newIndex > 0) newIndex--;
                if (dir === 'next' && newIndex < len - 1) newIndex++;
                if (newIndex >= 0 && newIndex < len && !membersListbox.options[newIndex].disabled) {
                    membersListbox.selectedIndex = newIndex;
                    // Trigger change to populate (One Click)
                    membersListbox.dispatchEvent(new Event('change'));
                }
            });
        }
    });

    // ==============================
    //4. ACTION BUTTONS LOGIC (UPDATED SAVE WITH QR & ID UPDATE)
    // ==============================
    document.querySelectorAll('.magic-action-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const selectedOpt = membersListbox.options[membersListbox.selectedIndex];
            const saveBtn = document.querySelector('button[data-action="save"]');

            if (action === 'add') {
                isEditMode = false;
                form.reset();
                resetPhotoUI();
                
                form_action_field.value = 'add'; 
                member_id_field.value = '';

                submitBtn.textContent = "Submit Registration";
                submitBtn.style.backgroundColor = "#333";
                submitBtn.style.color = "white";
                
                if(saveBtn) {
                    saveBtn.textContent = "Save";
                    saveBtn.style.backgroundColor = "#f3e5f5";
                    saveBtn.style.color = "#6a1b9a";
                }

                // --- NEW LOGIC: AUTO ID GENERATION (Fixed Padding) ---
                try {
                    const response = await fetch('/get_current_id');
                    const result = await response.json();
                    
                    let newIdString = ''; 
                    let lastIdString = result.idnumber || '';

                    if (lastIdString) {
                        // Split to handle formats like ID-00010
                        const parts = lastIdString.split('-');
                        // Assume the number is always the last part
                        let numPart = parts[parts.length - 1];
                        
                        // Extract digits only
                        const numericOnly = numPart.replace(/\D/g, '');
                        
                        if(numericOnly) {
                            const num = parseInt(numericOnly);
                            const nextNum = num + 1;
                            // Pad to the SAME length as the original numeric part
                            // e.g. 00010 (len 5) -> 11 -> 00011
                            const paddedNextNum = String(nextNum).padStart(numericOnly.length, '0');
                            
                            parts[parts.length - 1] = paddedNextNum;
                            newIdString = parts.join('-');
                        } else {
                            newIdString = '1'; // Fallback
                        }
                    } else {
                        // Table is empty, start with 1 (or ID-0001 depending on word)
                        // We'll default to simple 1 if no format is found
                        newIdString = '1';
                    }
                    
                    idNoField.value = newIdString;

                } catch (err) {
                    console.error("ID Gen Error:", err);
                    alert("Error generating ID via server.");
                }

                // --- FOCUS TO FULLNAME ---
                const nameField = document.getElementById('name_field');
                if(nameField) nameField.focus();
            }

            else if (action === 'edit') {
                if (!selectedOpt || selectedOpt.disabled) {
                    alert("Please select a member from list first.");
                    return;
                }

                isEditMode = true;
                // No need to dispatch change here, populateFieldsFromSelection already handles it via listbox listeners
                // Just trigger the logic manually if needed, but listeners are better.
                // We can trigger change:
                membersListbox.dispatchEvent(new Event('change'));
                
                form_action_field.value = 'update';

                submitBtn.textContent = "Update Registration";
                submitBtn.style.backgroundColor = "#ffc107";
                submitBtn.style.color = "#000";

                if(saveBtn) {
                    saveBtn.textContent = "Update";
                    saveBtn.style.backgroundColor = "#ffc107";
                    saveBtn.style.color = "#000";
                }
            }

            else if (action === 'save') {
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const confirmMsg = isEditMode ? "Are you sure you want to Update this record?" : "Are you sure you want to Save this new record?";
                if(confirm(confirmMsg)) {
                    
                    // --- NEW LOGIC: GENERATE QR CODE & UPDATE ID TABLE ---
                    
                    // 1. Generate QR Code using the ID Number
                    const currentId = idNoField.value;
                    const qrField = document.getElementById('qr_code_field');
                    
                    if (currentId && qrField && typeof QRious !== 'undefined') {
                        try {
                            const qr = new QRious({
                                value: currentId,
                                size: 200,
                                level: 'H'
                            });
                            qrField.value = qr.toDataURL(); // Save Base64 to hidden field
                        } catch (e) {
                            console.error("QR Error", e);
                        }
                    }

                    // 2. Update ID Regenerate Table (Only if NEW MEMBER)
                    // We update the database to the ID we just used for this member.
                    if (!isEditMode && currentId) {
                        try {
                            // Send the current ID to the database to update the sequence
                            await fetch('/save_id_to_db', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id_value: currentId })
                            });
                        } catch (err) {
                            console.error("Failed to update ID sequence:", err);
                            // We don't block the save if this fails, just log it.
                        }
                    }

                    // 3. Finally Submit the Form
                    form.submit();
                }
            }

            else if (action === 'cancel') {
                isEditMode = false;
                form.reset(); // Resets all inputs
                resetPhotoUI();
                
                form_action_field.value = 'add';
                member_id_field.value = '';
                idNoField.value = ''; // Clear ID specifically just to be safe

                submitBtn.textContent = "Submit Registration";
                submitBtn.style.backgroundColor = "#333";
                submitBtn.style.color = "white";

                if(saveBtn) {
                    saveBtn.textContent = "Save";
                    saveBtn.style.backgroundColor = "#f3e5f5";
                    saveBtn.style.color = "#6a1b9a";
                }
            }

            else if (action === 'delete') {
                if(selectedOpt && !selectedOpt.disabled) {
                     if(confirm('Delete this entry locally?')) {
                         selectedOpt.remove();
                         form.reset();
                         resetPhotoUI();
                         form_action_field.value = 'add';
                         member_id_field.value = '';
                     }
                } else {
                    alert("Select a member to delete.");
                }
            }
        });
    });

    // ==============================
    //5. SEQUENTIAL FOCUS (ENTER KEY)
    // ==============================
    const allInputs = Array.from(document.querySelectorAll('input, select, textarea'));
    
    allInputs.forEach((input, index) => {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submit
                
                // Find next visible input
                let nextIndex = index + 1;
                while (nextIndex < allInputs.length) {
                    const nextInput = allInputs[nextIndex];
                    // Skip hidden/disabled inputs
                    if (nextInput.type !== 'hidden' && !nextInput.disabled && nextInput.offsetParent !== null) {
                        nextInput.focus();
                        break;
                    }
                    nextIndex++;
                }
            }
        });
    });

    // ==============================
    //6. MODAL SEARCH LOGIC
    // ==============================
    window.openSearchModal = function () {
        const modal = document.getElementById('searchModal');
        const container = document.getElementById('searchFormContainer');
        fetch('/search')
            .then(res => res.text())
            .then(html => {
                container.innerHTML = html;
                modal.style.display = 'block';
            })
            .catch(err => alert('Error loading search'));
    };
    
    window.closeSearchModal = function () {
        document.getElementById('searchModal').style.display = 'none';
    };

    // ==============================
    //7. SIGNATURE PAD LOGIC (UPDATED FOR SMOOTH FINGER/COTTON BUGS INPUT)
    // ==============================
    const openSigBtn = document.getElementById('open_sig_btn');
    const signatureModal = document.getElementById('signatureModal');
    const sigCanvas = document.getElementById('signature-pad');
    const saveSigBtn = document.getElementById('save_sig_btn');
    const clearSigBtn = document.getElementById('clear_sig_btn');
    const deleteSigBtn = document.getElementById('delete_sig_btn'); // New Element
    const signatureField = document.getElementById('signature_field');

    let signaturePad = null;

    // --- IMPROVED RESIZE CANVAS FOR TOUCH ---
    function resizeCanvas() {
        if (signatureModal.style.display === 'none') return;
        
        // Kunin ang actual size ng canvas sa CSS
        const rect = sigCanvas.getBoundingClientRect();
        
        // Set internal size to match CSS size * pixelRatio
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        sigCanvas.width = rect.width * ratio;
        sigCanvas.height = rect.height * ratio;
        
        const ctx = sigCanvas.getContext("2d");
        ctx.scale(ratio, ratio);
    }

    if (openSigBtn && signatureModal) {
        openSigBtn.addEventListener('click', () => {
            signatureModal.style.display = 'block';
            
            // Wait for modal to render
            setTimeout(() => {
                resizeCanvas();
                
                if (!signaturePad) {
                    signaturePad = new SignaturePad(sigCanvas, {
                        backgroundColor: 'rgba(255, 255, 255, 0)',
                        penColor: 'rgb(0, 0, 0)',
                        
                        // --- CHANGES FOR SMOOTH FINGER/COTTON BUGS SIGNATURE ---
                        velocityFilterWeight: 0.85,
                        minDistance: 0.5,
                        throttle: 16
                        // -----------------------------------------------------------
                    });
                } else {
                    signaturePad.clear(); 
                }

                // Load Existing
                const currentSigData = signatureField.value;
                if (currentSigData && currentSigData.length > 20) {
                    try {
                        signaturePad.fromDataURL(currentSigData);
                    } catch (e) {
                        console.error("Error loading signature data", e);
                        signaturePad.clear();
                    }
                }

            }, 100); 
        });
    }

    if (saveSigBtn) {
        saveSigBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            if (!signaturePad) { 
                alert("Signature pad not initialized."); 
                return; 
            }
            
            if (signaturePad.isEmpty()) {
                alert("Please sign first before saving.");
                return;
            }

            const data = signaturePad.toDataURL('image/png');
            if (signatureField) {
                signatureField.value = data;
            }
            signatureModal.style.display = 'none';
        });
    }

    if (clearSigBtn) {
        clearSigBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!signaturePad) return;
            // Clear canvas lang para magsimula ulit
            signaturePad.clear();
        });
    }

    if (deleteSigBtn) {
        deleteSigBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!signaturePad) return;
            
            // Confirm Delete
            if(confirm("Delete signature? This will remove the saved signature.")) {
                signaturePad.clear();
                signatureField.value = ""; // Empty the textbox
                signatureModal.style.display = 'none'; // Close modal
            }
        });
    }

    window.addEventListener('click', (e) => {
        if (e.target == signatureModal) {
            signatureModal.style.display = 'none';
        }
    });

    document.addEventListener('DOMContentLoaded', resetPhotoUI);

})();
</script>

{% endblock %}
